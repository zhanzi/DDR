"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("xlsx"),e=require("html2canvas"),o=require("jspdf");function r(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}function n(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(o){if("default"!==o){var r=Object.getOwnPropertyDescriptor(t,o);Object.defineProperty(e,o,r.get?r:{enumerable:!0,get:function(){return t[o]}})}})),e.default=t,Object.freeze(e)}var a=n(t),i=r(e),l=function(){return l=Object.assign||function(t){for(var e,o=1,r=arguments.length;o<r;o++)for(var n in e=arguments[o])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t},l.apply(this,arguments)};function c(t,e,o,r){return new(o||(o=Promise))((function(n,a){function i(t){try{c(r.next(t))}catch(t){a(t)}}function l(t){try{c(r.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?n(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(i,l)}c((r=r.apply(t,e||[])).next())}))}function s(t,e){var o,r,n,a={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=l(0),i.throw=l(1),i.return=l(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function l(l){return function(c){return function(l){if(o)throw new TypeError("Generator is already executing.");for(;i&&(i=0,l[0]&&(a=0)),a;)try{if(o=1,r&&(n=2&l[0]?r.return:l[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,l[1])).done)return n;switch(r=0,n&&(l=[2&l[0],n.value]),l[0]){case 0:case 1:n=l;break;case 4:return a.label++,{value:l[1],done:!1};case 5:a.label++,r=l[1],l=[0];continue;case 7:l=a.ops.pop(),a.trys.pop();continue;default:if(!(n=a.trys,(n=n.length>0&&n[n.length-1])||6!==l[0]&&2!==l[0])){a=0;continue}if(3===l[0]&&(!n||l[1]>n[0]&&l[1]<n[3])){a.label=l[1];break}if(6===l[0]&&a.label<n[1]){a.label=n[1],n=l;break}if(n&&a.label<n[2]){a.label=n[2],a.ops.push(l);break}n[2]&&a.ops.pop(),a.trys.pop();continue}l=e.call(t,a)}catch(t){l=[6,t],r=0}finally{o=n=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,c])}}}"function"==typeof SuppressedError&&SuppressedError;var d,h=function(){function t(e){if(this.data=[],this.metadata={},this.pagination=null,this.filters={},this.eventListeners=new Map,this.formatters={},this.initialized=!1,this.options=e,"string"==typeof e.container){var o=document.querySelector(e.container);if(!o)throw new Error("找不到容器元素: ".concat(e.container));this.container=o}else{if(!(e.container instanceof HTMLElement))throw new Error("无效的容器元素");this.container=e.container}this.container.classList.add("ddr-container"),e.theme?this.container.classList.add("ddr-theme-".concat(e.theme)):this.container.classList.add("ddr-theme-default"),this.formatters=l({},t.globalFormatters),e.metadata&&(this.metadata=l({},e.metadata))}return t.create=function(e){var o=new t(e);return o.init().catch((function(t){e.onError?e.onError(t):console.error("DDR初始化失败:",t)})),o},t.registerFormatter=function(e,o){t.globalFormatters[e]=o},t.prototype.init=function(){return c(this,void 0,void 0,(function(){var t,e,o;return s(this,(function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),t=this,[4,this._loadConfig(this.options.config)];case 1:return t.config=r.sent(),[4,this._fetchData(this.config.dataSource)];case 2:return e=r.sent(),this.data=e.records,this.metadata=e.metadata||this.metadata,this.pagination=e.pagination||null,this._render(),this.initialized=!0,this._emitEvent("data-loaded",{data:this.data}),this.options.onLoad&&this.options.onLoad(),[3,4];case 3:throw o=r.sent(),this._emitEvent("error",{error:o}),o;case 4:return[2]}}))}))},t.prototype.reload=function(t){return c(this,void 0,void 0,(function(){var e,o;return s(this,(function(r){switch(r.label){case 0:if(!this.initialized)throw new Error("DDR尚未初始化");r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this._fetchData(this.config.dataSource,t)];case 2:return e=r.sent(),this.data=e.records,e.metadata&&(this.metadata=e.metadata,this._emitEvent("metadata-updated",{metadata:this.metadata})),this.pagination=e.pagination||null,this._render(),this._emitEvent("data-loaded",{data:this.data}),[3,4];case 3:throw o=r.sent(),this._emitEvent("error",{error:o}),o;case 4:return[2]}}))}))},t.prototype.refreshMetadata=function(){return c(this,void 0,void 0,(function(){var t,e,o;return s(this,(function(r){switch(r.label){case 0:if(!this.initialized)throw new Error("DDR尚未初始化");r.label=1;case 1:return r.trys.push([1,6,,7]),this.config.dataSource.metadataSource?[4,this._fetchMetadata(this.config.dataSource.metadataSource)]:[3,3];case 2:return t=r.sent(),this.metadata=t.metadata||{},[3,5];case 3:return[4,this._fetchData(this.config.dataSource)];case 4:(e=r.sent()).metadata&&(this.metadata=e.metadata),r.label=5;case 5:return this._renderHeaderFooter(),this._emitEvent("metadata-updated",{metadata:this.metadata}),[3,7];case 6:throw o=r.sent(),this._emitEvent("error",{error:o}),o;case 7:return[2]}}))}))},t.prototype.updateMetadata=function(t){this.metadata=l(l({},this.metadata),t),this.initialized&&(this._renderHeaderFooter(),this._emitEvent("metadata-updated",{metadata:this.metadata}))},t.prototype.exportTo=function(t,e){return c(this,void 0,void 0,(function(){var o,r;return s(this,(function(n){switch(n.label){case 0:if(!this.initialized)throw new Error("DDR尚未初始化");n.label=1;case 1:return n.trys.push([1,7,,8]),this._emitEvent("export-start",{type:t,options:e}),[4,Promise.resolve().then((function(){return g}))];case 2:return o=n.sent().Exporter,"excel"!==t?[3,4]:[4,o.toExcel(this.container,e)];case 3:return n.sent(),[3,6];case 4:return"pdf"!==t?[3,6]:[4,o.toPDF(this.container,this.config,e)];case 5:n.sent(),n.label=6;case 6:return this._emitEvent("export-complete",{type:t,fileName:(null==e?void 0:e.fileName)||"".concat(this.config.meta.name,".").concat("excel"===t?"xlsx":"pdf")}),[3,8];case 7:throw r=n.sent(),this._emitEvent("error",{error:r}),r;case 8:return[2]}}))}))},t.prototype.destroy=function(){this.container.innerHTML="",this.eventListeners.clear(),this.data=[],this.metadata={},this.initialized=!1},t.prototype.setFilter=function(t){this.filters=l(l({},this.filters),t)},t.prototype.on=function(t,e){this.eventListeners.has(t)||this.eventListeners.set(t,[]),this.eventListeners.get(t).push(e)},t.prototype.off=function(t,e){if(this.eventListeners.has(t)){var o=this.eventListeners.get(t),r=o.indexOf(e);-1!==r&&o.splice(r,1)}},t.prototype.print=function(){var t=document.createElement("style");t.textContent="\n      @media print {\n        body * {\n          visibility: hidden;\n        }\n        .ddr-container, .ddr-container * {\n          visibility: visible;\n        }\n        .ddr-container {\n          position: absolute;\n          left: 0;\n          top: 0;\n        }\n      }\n    ",document.head.appendChild(t),window.print(),document.head.removeChild(t)},t.prototype.getData=function(){return function(t,e,o){if(o||2===arguments.length)for(var r,n=0,a=e.length;n<a;n++)!r&&n in e||(r||(r=Array.prototype.slice.call(e,0,n)),r[n]=e[n]);return t.concat(r||Array.prototype.slice.call(e))}([],this.data,!0)},t.prototype.getMetadata=function(){return l({},this.metadata)},t.prototype._getValueByPath=function(t){if(t)return t.split(".").reduce((function(t,e){return t&&void 0!==t[e]?t[e]:void 0}),this.metadata)},t.prototype._loadConfig=function(t){return c(this,void 0,void 0,(function(){var e,o;return s(this,(function(r){switch(r.label){case 0:return"string"!=typeof t?[3,8]:t.startsWith("http")?[4,fetch(t)]:[3,3];case 1:case 4:if(!(e=r.sent()).ok)throw new Error("加载配置失败: ".concat(e.statusText));return[4,e.json()];case 2:case 5:return[2,r.sent()];case 3:return r.trys.push([3,6,,7]),[4,fetch(t)];case 6:throw o=r.sent(),new Error("加载配置失败: ".concat(o instanceof Error?o.message:String(o)));case 7:return[3,9];case 8:return[2,t];case 9:return[2]}}))}))},t.prototype._fetchData=function(t,e){return c(this,void 0,void 0,(function(){var o,r,n,a,i,c;return s(this,(function(s){switch(s.label){case 0:return!t.mock||this.options.debug&&"localhost"!==window.location.hostname?(o=l(l(l({},t.params),this.filters),e),"POST"===(r={method:t.method||"GET",headers:l({"Content-Type":"application/json"},t.headers||{})}).method&&(r.body=JSON.stringify(o)),n=t.api,"GET"===r.method&&Object.keys(o).length>0&&(a=new URLSearchParams,Object.entries(o).forEach((function(t){var e=t[0],o=t[1];a.append(e,String(o))})),n+="?".concat(a.toString())),[4,fetch(n,r)]):[2,{records:t.mock,metadata:this.metadata}];case 1:if(!(i=s.sent()).ok)throw new Error("API请求失败: ".concat(i.statusText));return[4,i.json()];case 2:if(!(c=s.sent()).success)throw new Error("API错误: ".concat(c.message||"状态码 ".concat(c.code)));return[2,{records:c.data.records||[],metadata:c.data.metadata,pagination:c.data.pagination}]}}))}))},t.prototype._fetchMetadata=function(t){return c(this,void 0,void 0,(function(){var e,o,r,n,a;return s(this,(function(i){switch(i.label){case 0:if(!t)throw new Error("未配置元数据源");return"POST"===(e={method:t.method||"GET",headers:{"Content-Type":"application/json"}}).method&&t.params&&(e.body=JSON.stringify(t.params)),o=t.api,"GET"===e.method&&t.params&&Object.keys(t.params).length>0&&(r=new URLSearchParams,Object.entries(t.params).forEach((function(t){var e=t[0],o=t[1];r.append(e,String(o))})),o+="?".concat(r.toString())),[4,fetch(o,e)];case 1:if(!(n=i.sent()).ok)throw new Error("元数据API请求失败: ".concat(n.statusText));return[4,n.json()];case 2:if(!(a=i.sent()).success)throw new Error("元数据API错误: ".concat(a.message||"状态码 ".concat(a.code)));return[2,{metadata:a.data.metadata||{}}]}}))}))},t.prototype._render=function(){var t;this.container.innerHTML="";var e=document.createElement("div");e.className="ddr-wrapper",this.config.layout&&(this.config.layout.height&&(e.style.height="number"==typeof this.config.layout.height?"".concat(this.config.layout.height,"px"):this.config.layout.height),this.config.layout.bordered&&e.classList.add("ddr-bordered")),this.container.appendChild(e);var o=this._determineRenderMode();e.setAttribute("data-render-mode",o),this._renderHeaderFooter(e),"canvas"===o?this._renderCanvas(e):this._renderDOM(e),(null===(t=this.config.features)||void 0===t?void 0:t.watermark)&&this._addWatermark(e,this.config.features.watermark),this._emitEvent("render-complete")},t.prototype._renderHeaderFooter=function(t){var e=t||this.container.querySelector(".ddr-wrapper");if(e){var o=e.querySelector(".ddr-report-header"),r=e.querySelector(".ddr-report-footer");if(o&&e.removeChild(o),r&&e.removeChild(r),this.config.header){var n=this._createHeader(this.config.header);if(n){e.insertBefore(n,e.firstChild),new ResizeObserver((function(t){for(var o=0,r=t;o<r.length;o++){var n=r[o].contentRect.height;e.style.setProperty("--header-height","".concat(n,"px"));var a=e.querySelector(".ddr-table-container");a&&(a.style.marginTop="10px",a.style.maxHeight="calc(100% - ".concat(n+10,"px - var(--footer-height, 0px))"))}})).observe(n);var a=n.getBoundingClientRect().height;e.style.setProperty("--header-height","".concat(a,"px")),(i=e.querySelector(".ddr-table-container"))&&(i.style.marginTop="10px",i.style.maxHeight="calc(100% - ".concat(a+10,"px - var(--footer-height, 0px))"))}}if(this.config.footer&&this.initialized){var i,l=this._createFooter(this.config.footer);if(l)(i=e.querySelector(".ddr-table-container"))?e.insertBefore(l,i.nextSibling):e.appendChild(l)}}},t.prototype._createHeader=function(t){var e=this;if(!t)return null;var o=document.createElement("div");o.className="ddr-report-header",o.style.minHeight="".concat(t.height||80,"px");var r=document.createElement("div");if(r.className="ddr-header-top",t.logo){var n=document.createElement("div");n.className="ddr-header-logo ddr-header-logo-".concat(t.logo.position||"left");var a=document.createElement("img");a.alt="Logo",a.src=t.logo.metadataKey?this._getValueByPath(t.logo.metadataKey)||t.logo.url||"":t.logo.url||"",t.logo.width&&(a.width=t.logo.width),t.logo.height&&(a.height=t.logo.height),n.appendChild(a),r.appendChild(n)}var i=document.createElement("div");if(i.className="ddr-header-center",t.title){var l="string"==typeof t.title?t.title:t.title.metadataPath&&this._getValueByPath(t.title.metadataPath)||t.title.text,c=document.createElement("h2");c.className="ddr-header-title",c.textContent=l,"object"==typeof t.title&&t.title.style&&Object.assign(c.style,t.title.style),i.appendChild(c)}if(t.subtitle){var s=document.createElement("div");s.className="ddr-header-subtitle",s.textContent=t.subtitle,i.appendChild(s)}if(r.appendChild(i),o.appendChild(r),t.fields&&t.fields.length>0){var d=document.createElement("div");d.className="ddr-header-fields";var h=document.createElement("div");h.className="ddr-header-fields-left";var u=document.createElement("div");u.className="ddr-header-fields-right",t.fields.forEach((function(t){var o=document.createElement("div");o.className="ddr-header-field";var r=document.createElement("span");r.className="ddr-field-label",r.textContent=t.label||"",o.appendChild(r);var n=document.createElement("span");n.className="ddr-field-value";var a=t.metadataPath?e._getValueByPath(t.metadataPath):t.value||"";void 0!==a&&t.formatter&&e.formatters[t.formatter]&&(a=e.formatters[t.formatter](a)),n.textContent=void 0!==a?String(a):"",o.appendChild(n),t.style&&Object.assign(o.style,t.style),"right"===t.position?u.appendChild(o):h.appendChild(o)})),d.appendChild(h),d.appendChild(u),o.appendChild(d)}return o},t.prototype._createFooter=function(t){var e=this;if(!t)return null;var o=document.createElement("div");if(o.className="ddr-report-footer",o.style.minHeight="".concat(t.height||100,"px"),t.fixed&&o.classList.add("ddr-footer-fixed"),t.summary&&t.summary.length>0){var r=document.createElement("div");r.className="ddr-footer-summary",t.summary.forEach((function(t){var o=document.createElement("div");o.className="ddr-summary-item";var n=document.createElement("span");n.className="ddr-summary-label",n.textContent="".concat(t.column,"合计:");var a,i=document.createElement("span");i.className="ddr-summary-value",a=t.metadataPath?e._getValueByPath(t.metadataPath):e._calculateSummary(e.data,t),t.formatter&&e.formatters[t.formatter]&&(a=e.formatters[t.formatter](a)),i.textContent=void 0!==a?String(a):"",o.appendChild(n),o.appendChild(i),r.appendChild(o)})),o.appendChild(r)}if(t.fields&&t.fields.length>0){var n=document.createElement("div");n.className="ddr-footer-fields",t.fields.forEach((function(t){var o=document.createElement("div");o.className="ddr-footer-field ddr-align-".concat(t.position||"left");var r=document.createElement("span");r.className="ddr-field-label",r.textContent=t.label||"",o.appendChild(r);var a=document.createElement("span");a.className="ddr-field-value";var i=t.metadataPath?e._getValueByPath(t.metadataPath):t.value||"";void 0!==i&&t.formatter&&e.formatters[t.formatter]&&(i=e.formatters[t.formatter](i)),a.textContent=void 0!==i?String(i):"",o.appendChild(a),t.style&&Object.assign(o.style,t.style),n.appendChild(o)})),o.appendChild(n)}if(t.signatures&&t.signatures.length>0){var a=document.createElement("div");a.className="ddr-footer-signatures",t.signatures.forEach((function(t){var o=document.createElement("div");o.className="ddr-signature-item";var r=document.createElement("div");r.className="ddr-signature-label",r.textContent=t.label||"",o.appendChild(r);var n=document.createElement("div");n.className="ddr-signature-name";var i=t.metadataPath?e._getValueByPath(t.metadataPath):t.name||"";if(n.textContent=i||"",o.appendChild(n),t.showTimestamp){var l=document.createElement("div");l.className="ddr-signature-date";var c=t.dateMetadataPath?e._getValueByPath(t.dateMetadataPath):null;c&&(l.textContent=new Date(c).toLocaleDateString()),o.appendChild(l)}t.width&&(o.style.width="".concat(t.width,"px")),a.appendChild(o)})),o.appendChild(a)}if(t.notes){var i=document.createElement("div");i.className="ddr-footer-notes",i.textContent=t.notes,o.appendChild(i)}if(t.pageInfo&&this.pagination){var l=document.createElement("div");l.className="ddr-footer-page ddr-align-".concat(t.pageInfo.position||"right");var c=t.pageInfo.format.replace("{current}",String(this.pagination.pageNumber||1)).replace("{total}",String(this.pagination.totalPages||1));l.textContent=c,o.appendChild(l)}return o},t.prototype._calculateSummary=function(t,e){if(!t.length)return 0;var o=t.map((function(t){var o=t[e.column];return"number"==typeof o?o:0}));switch(e.type){case"sum":return o.reduce((function(t,e){return t+e}),0);case"avg":return o.reduce((function(t,e){return t+e}),0)/o.length;case"count":return o.length;default:return 0}},t.prototype._determineRenderMode=function(){return"dom"===this.options.mode||"canvas"===this.options.mode?this.options.mode:this.data.length>5e3?"canvas":"dom"},t.prototype._renderDOM=function(t){var e,o=document.createElement("div");o.className="ddr-table-container";var r=t.querySelector(".ddr-report-header");if(r)if(window.ResizeObserver){new ResizeObserver((function(e){for(var n=0,a=e;n<a.length;n++){var i=a[n];if(i.target===r){var l=i.contentRect.height;t.style.setProperty("--header-height","".concat(l,"px")),t.style.setProperty("--table-offset-top","".concat(l,"px")),o.style.marginTop="20px"}}})).observe(r)}else{var n=function(){var e=r.getBoundingClientRect().height;t.style.setProperty("--header-height","".concat(e,"px")),t.style.setProperty("--table-offset-top","".concat(e,"px")),o.style.marginTop="20px"};n(),window.addEventListener("resize",n)}var a=document.createElement("div");a.className="ddr-table-wrapper";var i=document.createElement("table");i.className="ddr-table",this.config.layout&&(this.config.layout.stripe&&i.classList.add("ddr-table-stripe"),this.config.layout.hover&&i.classList.add("ddr-table-hover"));var l=this._createTableHeader(this.config.columns);i.appendChild(l);var c=this._createTableBody(this.config.columns,this.data);if(i.appendChild(c),a.appendChild(i),o.appendChild(a),t.appendChild(o),(null===(e=this.config.features)||void 0===e?void 0:e.pagination)&&this.pagination){var s=this._createPagination(this.pagination);t.appendChild(s)}if(this.config.footer){var d=this._createFooter(this.config.footer);d&&t.appendChild(d)}},t.prototype._renderCanvas=function(t){var e=document.createElement("div");e.className="ddr-canvas-placeholder",e.textContent="使用Canvas模式渲染".concat(this.data.length,"行数据"),t.appendChild(e),console.log("实际项目中需要实现Canvas渲染引擎")},t.prototype._createTableHeader=function(t){var e=document.createElement("thead");e.className="ddr-thead";var o=this._calculateHeaderRowCount(t),r=Array(o).fill(null).map((function(){var t=document.createElement("tr");return t.className="ddr-header-row",t}));return this._fillHeaderCells(t,r,0,0),r.forEach((function(t){e.appendChild(t)})),e},t.prototype._calculateHeaderRowCount=function(t){var e=1,o=function(t,r){void 0===r&&(r=1),t.forEach((function(t){t.children&&t.children.length&&(e=Math.max(e,r+1),o(t.children,r+1))}))};return o(t),e},t.prototype._fillHeaderCells=function(t,e,o,r){var n=this,a=r;return t.forEach((function(t){var r=document.createElement("th");if(r.className="ddr-header-cell",r.textContent=t.title,t.align&&(r.style.textAlign=t.align),t.width&&(r.style.width="number"==typeof t.width?"".concat(t.width,"px"):t.width),t.children&&t.children.length){var i=n._fillHeaderCells(t.children,e,o+1,a);r.colSpan=i,r.rowSpan=1,a+=i}else r.colSpan=1,r.rowSpan=e.length-o,a+=1;e[o].appendChild(r)})),a-r},t.prototype._createTableBody=function(t,e){var o,r=this,n=document.createElement("tbody");n.className="ddr-tbody";var a=this._getFlatColumns(t);if(!e.length){var i=document.createElement("tr");i.className="ddr-empty-row";var l=document.createElement("td");return l.className="ddr-empty-cell",l.colSpan=a.length,l.textContent=(null===(o=this.config.features)||void 0===o?void 0:o.emptyText)||"暂无数据",i.appendChild(l),n.appendChild(i),n}return e.forEach((function(t,e){var o=document.createElement("tr");o.className="ddr-body-row",o.setAttribute("data-index",String(e)),a.forEach((function(e){var n;if(!1!==e.visible){e.merge;var a=document.createElement("td");a.className="ddr-body-cell";var i=t[e.key];if(e.formatter)if("string"==typeof e.formatter&&r.formatters[e.formatter])i=r.formatters[e.formatter](i);else if("object"==typeof e.formatter){var l=r.formatters[e.formatter.type];l&&(i=l(i,e.formatter.params))}a.textContent=null!=i?String(i):"",e.align&&(a.style.textAlign=e.align),(null===(n=e.style)||void 0===n?void 0:n.conditional)&&e.style.conditional.forEach((function(o){var n=t[e.key];try{r._evaluateCondition(o.when,{value:n,row:t})&&Object.assign(a.style,o.style)}catch(t){console.error("条件解析错误:",t)}})),o.appendChild(a)}})),n.appendChild(o)})),n},t.prototype._evaluateCondition=function(t,e){try{var o=t,r=(o=o.replace(/value/g,JSON.stringify(e.value))).match(/row\.\w+/g);return r&&r.forEach((function(t){var r=t.split(".")[1];o=o.replace(t,JSON.stringify(e.row[r]))})),new Function("return ".concat(o))()}catch(e){return console.error("条件解析错误:",e,t),!1}},t.prototype._getFlatColumns=function(t){var e=[],o=function(t){t.forEach((function(t){t.children&&t.children.length?o(t.children):e.push(t)}))};return o(t),e},t.prototype._createPagination=function(t){var e=this,o=document.createElement("div");o.className="ddr-pagination";var r=document.createElement("span");r.className="ddr-pagination-info",r.textContent="第".concat(t.pageNumber||1,"页/共").concat(t.totalPages||1,"页"),o.appendChild(r);var n=document.createElement("button");n.className="ddr-pagination-prev",n.textContent="上一页",n.disabled=(t.pageNumber||1)<=1,n.onclick=function(){e.reload(l(l({},e.filters),{pageNumber:(t.pageNumber||1)-1}))},o.appendChild(n);for(var a=t.totalPages||1,i=t.pageNumber||1,c=Math.max(1,i-2),s=Math.min(a,c+4),d=function(t){var r=document.createElement("button");r.className="ddr-pagination-page".concat(t===i?" active":""),r.textContent=String(t),r.onclick=function(){t!==i&&e.reload(l(l({},e.filters),{pageNumber:t}))},o.appendChild(r)},h=c=Math.max(1,s-4);h<=s;h++)d(h);var u=document.createElement("button");u.className="ddr-pagination-next",u.textContent="下一页",u.disabled=(t.pageNumber||1)>=(t.totalPages||1),u.onclick=function(){e.reload(l(l({},e.filters),{pageNumber:(t.pageNumber||1)+1}))},o.appendChild(u);var f=document.createElement("select");return f.className="ddr-pagination-size",[10,20,50,100].forEach((function(e){var o=document.createElement("option");o.value=String(e),o.textContent="".concat(e,"条/页"),o.selected=e===(t.pageSize||20),f.appendChild(o)})),f.onchange=function(t){var o=Number(t.target.value);e.reload(l(l({},e.filters),{pageSize:o,pageNumber:1}))},o.appendChild(f),o},t.prototype._addWatermark=function(t,e){var o=this,r=t.querySelector(".ddr-watermark");r&&t.removeChild(r);var n=document.createElement("div");n.className="ddr-watermark",n.style.zIndex="10",e.includes("${")&&(e=e.replace(/\${([^}]+)}/g,(function(t,e){return String(o._getValueByPath(e)||t)})));for(var a=0;a<20;a++){var i=document.createElement("div");i.className="ddr-watermark-content",i.textContent=e,i.style.opacity="0.2",i.style.color="rgba(0, 0, 0, 0.25)",i.style.fontSize="18px",n.appendChild(i)}Object.defineProperty(n.style,"pointerEvents",{value:"none",writable:!1}),t.appendChild(n),new MutationObserver((function(e){e.forEach((function(e){if("childList"===e.type&&Array.from(e.removedNodes).some((function(t){return t===n||t instanceof Element&&t.querySelector(".ddr-watermark")}))&&!t.contains(n)){var o=n.cloneNode(!0);setTimeout((function(){return t.appendChild(o)}),100)}"attributes"!==e.type||e.target!==n||"style"!==e.attributeName&&"class"!==e.attributeName||(n.className="ddr-watermark",n.style.zIndex="10",n.style.opacity="0.8")}))})).observe(t,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]})},t.prototype._prepareExportData=function(t){var e,o,r,n,a,i,l,c,s,d,h,u,f=this,m=this._getFlatColumns(this.config.columns).filter((function(e){return!1!==e.visible&&((null==t?void 0:t.includeHidden)||!1!==e.visible)})),g=[];if(!1!==(null==t?void 0:t.includeHeader)&&!1!==(null===(e=this.config.header)||void 0===e?void 0:e.showOnExport)){if(null===(o=this.config.header)||void 0===o?void 0:o.title){var p="string"==typeof this.config.header.title?this.config.header.title:this.config.header.title.text;g.push([p]),g.push([])}(null===(n=null===(r=this.config.header)||void 0===r?void 0:r.fields)||void 0===n?void 0:n.length)&&(this.config.header.fields.forEach((function(t){var e=t.metadataPath?f._getValueByPath(t.metadataPath):t.value||"";g.push(["".concat(t.label||""),e])})),g.push([]))}var v=m.map((function(t){return t.title}));if(g.push(v),this.data.forEach((function(t){var e=m.map((function(e){var o=t[e.key];if(e.formatter)if("string"==typeof e.formatter&&f.formatters[e.formatter])o=f.formatters[e.formatter](o);else if("object"==typeof e.formatter){var r=f.formatters[e.formatter.type];r&&(o=r(o,e.formatter.params))}return o}));g.push(e)})),!1!==(null==t?void 0:t.includeFooter)&&!1!==(null===(a=this.config.footer)||void 0===a?void 0:a.showOnExport)){if(g.push([]),(null===(l=null===(i=this.config.footer)||void 0===i?void 0:i.summary)||void 0===l?void 0:l.length)&&(this.config.footer.summary.forEach((function(t){var e;e=t.metadataPath?f._getValueByPath(t.metadataPath):f._calculateSummary(f.data,t),t.formatter&&f.formatters[t.formatter]&&(e=f.formatters[t.formatter](e)),g.push(["".concat(t.column,"合计:"),e])})),g.push([])),(null===(s=null===(c=this.config.footer)||void 0===c?void 0:c.fields)||void 0===s?void 0:s.length)&&this.config.footer.fields.forEach((function(t){var e=t.metadataPath?f._getValueByPath(t.metadataPath):t.value||"";g.push([t.label||"",e])})),null===(h=null===(d=this.config.footer)||void 0===d?void 0:d.signatures)||void 0===h?void 0:h.length){var y=[];this.config.footer.signatures.forEach((function(t){y.push(t.label||"");var e=t.metadataPath?f._getValueByPath(t.metadataPath):t.name||"";y.push(e)})),g.push(y)}(null===(u=this.config.footer)||void 0===u?void 0:u.notes)&&g.push([this.config.footer.notes])}return g},t.prototype._emitEvent=function(t,e){this.eventListeners.has(t)&&this.eventListeners.get(t).forEach((function(o){try{o(e)}catch(e){console.error("事件".concat(t,"处理错误:"),e)}}))},t.globalFormatters={date:function(t){return new Date(t).toLocaleDateString()},currency:function(t,e){var o=e||{},r=o.currency,n=void 0===r?"CNY":r,a=o.locale,i=void 0===a?"zh-CN":a;return new Intl.NumberFormat(i,{style:"currency",currency:n}).format(t)},number:function(t,e){var o=e||{},r=o.precision,n=void 0===r?2:r,a=o.thousandSeparator,i={minimumFractionDigits:n,maximumFractionDigits:n,useGrouping:void 0===a||a};return new Intl.NumberFormat(void 0,i).format(t)},percentage:function(t,e){var o=(e||{}).precision,r=void 0===o?2:o;return new Intl.NumberFormat(void 0,{style:"percent",minimumFractionDigits:r,maximumFractionDigits:r}).format(t)}},t}();function u(t,e){var o={header:{font:{bold:!0,sz:12,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:"4472C4"}},alignment:{horizontal:"center",vertical:"center",wrapText:!0},border:{top:{style:"medium",color:{rgb:"366092"}},right:{style:"thin",color:{rgb:"366092"}},bottom:{style:"medium",color:{rgb:"366092"}},left:{style:"thin",color:{rgb:"366092"}}}},title:{font:{bold:!0,sz:18,color:{rgb:"000000"}},alignment:{horizontal:"center",vertical:"center"},border:{top:{style:"thin",color:{rgb:"CCCCCC"}},bottom:{style:"thin",color:{rgb:"CCCCCC"}}}},metadata:{font:{sz:11,color:{rgb:"333333"}},alignment:{horizontal:"left",vertical:"center"},border:{top:{style:"thin",color:{rgb:"EEEEEE"}},right:{style:"thin",color:{rgb:"EEEEEE"}},bottom:{style:"thin",color:{rgb:"EEEEEE"}},left:{style:"thin",color:{rgb:"EEEEEE"}}}},cell:{font:{sz:11,color:{rgb:"333333"}},alignment:{vertical:"center",wrapText:!0},border:{top:{style:"thin",color:{rgb:"DDDDDD"}},right:{style:"thin",color:{rgb:"DDDDDD"}},bottom:{style:"thin",color:{rgb:"DDDDDD"}},left:{style:"thin",color:{rgb:"DDDDDD"}}}},oddRow:{fill:{fgColor:{rgb:"E9EDF4"}}},evenRow:{fill:{fgColor:{rgb:"FFFFFF"}}},summary:{font:{bold:!0,sz:11,color:{rgb:"000000"}},alignment:{horizontal:"right",vertical:"center"},border:{top:{style:"medium",color:{rgb:"CCCCCC"}},bottom:{style:"medium",color:{rgb:"CCCCCC"}}}}};if(!e||0===e.length)return t;var r=function(t){if(t.length<3)return 0;for(var e=0;e<Math.min(10,t.length-1);e++)if(t[e]&&t[e+1]&&t[e].length===t[e+1].length&&t[e].length>=3)return e;return 0}(e),n=function(t,e){var o={titleRowIndex:-1,dataEndRowIndex:t.length-1,summaryRowIndices:[]};e>0&&(o.titleRowIndex=0);for(var r=t.length-1;r>e;r--){var n=t[r];if(n&&0!==n.length){for(var a=!1,i=0;i<n.length;i++){var l=n[i];if(l&&"string"==typeof l&&(l.includes("合计")||l.includes("总计")||l.includes("汇总")||l.includes("小计"))){a=!0,o.summaryRowIndices.push(r);break}}a||o.dataEndRowIndex!==t.length-1||(o.dataEndRowIndex=r)}}return o}(e,r);if(n.titleRowIndex>=0)for(var i=0;i<=n.titleRowIndex;i++)for(var c=0;c<(e[i]?e[i].length:0);c++){t[m=a.utils.encode_cell({r:i,c:c})]&&(t[m].s=0===i&&0===c?o.title:o.metadata)}if(r>=0)for(c=0;c<e[r].length;c++){t[m=a.utils.encode_cell({r:r,c:c})]&&(t[m].s=o.header)}for(i=r+1;i<=n.dataEndRowIndex;i++){var s=(i-r)%2==1;for(c=0;c<(e[i]?e[i].length:0);c++){if(t[m=a.utils.encode_cell({r:i,c:c})]){var d=f(e[i][c]);t[m].s=l(l(l({},o.cell),s?o.oddRow:o.evenRow),{alignment:l(l({},o.cell.alignment),{horizontal:d?"right":"left"})})}}}if(n.summaryRowIndices.length>0)for(var h=0,u=n.summaryRowIndices;h<u.length;h++)for(i=u[h],c=0;c<(e[i]?e[i].length:0);c++){var m;t[m=a.utils.encode_cell({r:i,c:c})]&&(t[m].s=o.summary)}return t}function f(t){if(null==t)return!1;if("number"==typeof t)return!0;if("string"==typeof t){var e=t.trim();return""!==e&&(!isNaN(Number(e))&&!isNaN(parseFloat(e))&&!e.includes(" "))}return!1}try{d=require("xlsx-js-style"),console.log("使用支持样式的XLSX库")}catch(t){d=a,console.log("使用标准XLSX库（样式支持有限）")}"undefined"!=typeof window&&setTimeout((function(){try{console.log("jsPDF库已内置到组件中"),function(){try{console.log("PDF导出修复已应用 (使用内置jsPDF)"),console.log("PDF导出修复已成功应用")}catch(t){console.warn("应用PDF修复时发生错误:",t)}}()}catch(t){console.warn("应用PDF导出修复失败:",t)}}),0);var m=function(){function t(){}return t.toExcel=function(t,e){return void 0===e&&(e={}),c(this,void 0,void 0,(function(){var o,r,n,a,i,l,c,h,u,f,m,g,p,v,y,b,C,w,E,x,S,F;return s(this,(function(s){try{if(o=e.fileName,r=void 0===o?"报表":o,n=e.sheetName,a=void 0===n?"Sheet1":n,i=e.includeHidden,l=e.styles,c=void 0,h=null,t instanceof HTMLElement?(h=t,c=this.extractDataFromDOM(t)):c=t,u=d.utils.aoa_to_sheet(c),f=[],c.length>0){for(m=function(t){var e=10;c.forEach((function(o){o[t]&&String(o[t]).length>e&&(e=Math.min(50,String(o[t]).length))})),f.push({wch:e})},g=0;g<c[0].length;g++)m(g);u["!cols"]=f}console.log("Excel导出数据结构:",{dataRows:c.length,hasDOMElement:!!h,firstRow:c[0],lastRow:c[c.length-1]}),console.log("使用增强样式应用到Excel");try{this.applyEnhancedStylesToExcel(u,c),console.log("增强样式应用成功")}catch(t){console.warn("增强样式应用失败，回退到基础样式:",t),this.applyBasicStylesToExcel(u,c)}["A1","A2","B1","B2"].forEach((function(t){u[t]&&console.log("单元格 ".concat(t," 样式:"),u[t].s)})),p=d.utils.book_new(),d.utils.book_append_sheet(p,u,a),p.Workbook||(p.Workbook={}),p.Workbook.Views||(p.Workbook.Views=[]),p.Workbook.Views[0]={RTL:!1};try{for(v=!1,y=0,b=["A1","A2","B1"];y<b.length;y++)if(u[C=b[y]]&&u[C].s){v=!0;break}console.log("Excel导出信息: 工作表包含".concat(Object.keys(u).length,"个单元格, 样式信息: ").concat(v?"有":"无")),p.Props={Title:r,Subject:"报表数据",Author:"DDR报表组件",CreatedDate:new Date};try{w={bookType:"xlsx",type:"buffer",cellStyles:!0,sheetStubs:!1,compression:!0},E=d.write(p,w),x=new Blob([E],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),S=window.URL.createObjectURL(x),(F=document.createElement("a")).href=S,F.download="".concat(r,".xlsx"),document.body.appendChild(F),F.click(),document.body.removeChild(F),window.URL.revokeObjectURL(S),console.log("Excel导出完成（Blob方式，支持样式）")}catch(t){console.warn("Blob导出失败，尝试直接导出:",t),d.writeFile(p,"".concat(r,".xlsx"),{cellStyles:!0,compression:!0}),console.log("Excel导出完成（直接导出方式）")}}catch(t){console.error("Excel导出失败:",t);try{d.writeFile(p,"".concat(r,".xlsx")),console.log("Excel导出完成（基础模式）")}catch(t){throw console.error("Excel基础导出也失败:",t),t}}return[2,Promise.resolve()]}catch(t){return[2,Promise.reject(t)]}return[2]}))}))},t.extractDataFromDOM=function(t){var e,o=[],r=t.querySelector(".ddr-report-header .ddr-header-title");r&&(o.push([(null===(e=r.textContent)||void 0===e?void 0:e.trim())||""]),o.push([]));var n=t.querySelectorAll(".ddr-header-fields .ddr-header-field");if(n.length>0){var a=[];n.forEach((function(t){var e,o,r,n,i=(null===(o=null===(e=t.querySelector(".ddr-field-label"))||void 0===e?void 0:e.textContent)||void 0===o?void 0:o.trim())||"",l=(null===(n=null===(r=t.querySelector(".ddr-field-value"))||void 0===r?void 0:r.textContent)||void 0===n?void 0:n.trim())||"";i&&l&&a.push("".concat(i," ").concat(l))})),a.length>0&&(o.push(a),o.push([]))}var i=t.querySelector("table");i&&i.querySelectorAll("tr").forEach((function(t){var e=t.querySelectorAll("td, th"),r=[];e.forEach((function(t){var e;r.push((null===(e=t.textContent)||void 0===e?void 0:e.trim())||"")})),r.length>0&&o.push(r)}));var l=t.querySelector(".ddr-report-footer");if(l){o.push([]);var c=l.querySelectorAll(".ddr-footer-summary .ddr-summary-item");if(c.length>0){var s=[];c.forEach((function(t){var e,o,r,n,a=(null===(o=null===(e=t.querySelector(".ddr-summary-label"))||void 0===e?void 0:e.textContent)||void 0===o?void 0:o.trim())||"",i=(null===(n=null===(r=t.querySelector(".ddr-summary-value"))||void 0===r?void 0:r.textContent)||void 0===n?void 0:n.trim())||"";a&&i&&s.push("".concat(a," ").concat(i))})),s.length>0&&o.push(s)}var d=l.querySelectorAll(".ddr-footer-fields .ddr-footer-field");if(d.length>0){var h=[];d.forEach((function(t){var e,o,r,n,a=(null===(o=null===(e=t.querySelector(".ddr-field-label"))||void 0===e?void 0:e.textContent)||void 0===o?void 0:o.trim())||"",i=(null===(n=null===(r=t.querySelector(".ddr-field-value"))||void 0===r?void 0:r.textContent)||void 0===n?void 0:n.trim())||"";a&&i&&h.push("".concat(a," ").concat(i))})),h.length>0&&o.push(h)}}return o},t.applyDOMStylesToExcel=function(t,e,o){console.log("开始应用DOM样式到Excel");try{var r=o.querySelector("table");if(!r)return console.log("未找到表格，使用默认样式"),void u(t,e);var n=!!o.querySelector(".ddr-report-header .ddr-header-title"),i=o.querySelectorAll(".ddr-header-fields .ddr-header-field").length>0;console.log("DOM结构分析:",{hasTitle:n,hasMetadata:i});var l=0,c={font:{bold:!0,sz:12,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:"4472C4"}},alignment:{horizontal:"center",vertical:"center"}},s={font:{sz:11},alignment:{vertical:"center"}};if(n){var h=a.utils.encode_cell({r:l,c:0});t[h]&&(t[h].s={font:{bold:!0,sz:16},alignment:{horizontal:"center",vertical:"center"}},console.log("应用标题样式到 ".concat(h))),l+=2}i&&(l+=2);var f=r.querySelectorAll("tr"),m=!0;f.forEach((function(e,o){var r=e.querySelectorAll("td, th"),n=null!==e.querySelector("th")||m;r.forEach((function(e,r){var a=l+o,i=d.utils.encode_cell({r:a,c:r});t[i]&&(n?(t[i].s=c,console.log("应用表头样式到 ".concat(i))):t[i].s=s)})),m&&n&&(m=!1)})),console.log("DOM样式应用完成")}catch(o){console.error("应用DOM样式失败:",o),u(t,e)}},t.applyBasicStylesToExcel=function(t,e){console.log("开始应用基础样式到Excel");try{for(var o=d.utils.decode_range(t["!ref"]||"A1"),r=o.s.c;r<=o.e.c;r++){t[a=d.utils.encode_cell({r:0,c:r})]&&(t[a].s={font:{bold:!0,sz:12},fill:{fgColor:{rgb:"DDDDDD"}},alignment:{horizontal:"center",vertical:"center"}},console.log("应用表头样式到 ".concat(a)))}for(var n=1;n<=o.e.r;n++)for(r=o.s.c;r<=o.e.c;r++){var a;t[a=d.utils.encode_cell({r:n,c:r})]&&(t[a].s={font:{sz:10},alignment:{vertical:"center"}})}console.log("基础样式应用完成")}catch(t){console.error("应用基础样式失败:",t)}},t.applyEnhancedStylesToExcel=function(t,e){console.log("开始应用增强样式到Excel");try{for(var o=d.utils.decode_range(t["!ref"]||"A1"),r={font:{bold:!0,sz:12,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:"4472C4"}},alignment:{horizontal:"center",vertical:"center"},border:{top:{style:"thin",color:{rgb:"000000"}},bottom:{style:"thin",color:{rgb:"000000"}},left:{style:"thin",color:{rgb:"000000"}},right:{style:"thin",color:{rgb:"000000"}}}},n={font:{sz:10},alignment:{vertical:"center"},border:{top:{style:"thin",color:{rgb:"CCCCCC"}},bottom:{style:"thin",color:{rgb:"CCCCCC"}},left:{style:"thin",color:{rgb:"CCCCCC"}},right:{style:"thin",color:{rgb:"CCCCCC"}}}},a={font:{sz:10},fill:{fgColor:{rgb:"F8F9FA"}},alignment:{vertical:"center"},border:{top:{style:"thin",color:{rgb:"CCCCCC"}},bottom:{style:"thin",color:{rgb:"CCCCCC"}},left:{style:"thin",color:{rgb:"CCCCCC"}},right:{style:"thin",color:{rgb:"CCCCCC"}}}},i=o.s.c;i<=o.e.c;i++){t[s=d.utils.encode_cell({r:0,c:i})]&&(t[s].s=r,console.log("应用增强表头样式到 ".concat(s)))}for(var l=1;l<=o.e.r;l++){var c=l%2==0?a:n;for(i=o.s.c;i<=o.e.c;i++){var s;t[s=d.utils.encode_cell({r:l,c:i})]&&(t[s].s=c)}}t["!cols"]||(t["!cols"]=[]);for(i=o.s.c;i<=o.e.c;i++)t["!cols"][i]={wch:15};console.log("增强样式应用完成")}catch(o){console.error("应用增强样式失败，回退到基础样式:",o),this.applyBasicStylesToExcel(t,e)}},t.rgbToHex=function(t){if(!t||"transparent"===t)return"FFFFFF";var e=t.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);return e?(parseInt(e[1])<<16|parseInt(e[2])<<8|parseInt(e[3])).toString(16).padStart(6,"0").toUpperCase():"FFFFFF"},t.getExcelAlignment=function(t){switch(t){case"center":return"center";case"right":return"right";case"justify":return"justify";default:return"left"}},t.toPDF=function(t,e,r){var n,a,d,h,u;return void 0===r&&(r={}),c(this,void 0,void 0,(function(){var c,f,m,g,p,v,y,b,C,w,E,x,S,F,P,_,D,M,N,R,O,T,k,z,j,L,q,A,I,B,H,V,W,G,U,J,Y,X,K,$,Q,Z,tt,et,ot,rt,nt,at,it,lt,ct,st,dt,ht,ut,ft,mt,gt,pt,vt,yt,bt,Ct,wt,Et,xt,St,Ft,Pt,_t,Dt,Mt,Nt,Rt,Ot,Tt,kt,zt,jt,Lt,qt,At,It,Bt,Ht,Vt,Wt,Gt,Ut,Jt,Yt,Xt,Kt,$t,Qt,Zt,te,ee,oe,re,ne,ae,ie,le,ce,se;return s(this,(function(s){switch(s.label){case 0:if(s.trys.push([0,14,,15]),console.log("PDF导出开始，使用内置jsPDF库"),c=r.fileName,f=void 0===c?"报表":c,m=r.watermark,g=void 0===m?"":m,p=r.pdf,v=void 0===p?{}:p,y=(null===(n=null==e?void 0:e.features)||void 0===n?void 0:n.pdfConfig)||{},b=l(l({},y),v),console.log("PDF导出配置:",{configPdfSettings:y,pdfOptions:v,mergedPdfOptions:b}),C=b.pageSize||"A4",w=b.orientation||"portrait",E=b.quality||.95,x=!1!==b.multiPage,S=!1!==b.relayout,console.log("PDF设置 - 页面大小: ".concat(C,", 方向: ").concat(w,", 重新排版: ").concat(S)),F={top:(null===(a=b.margins)||void 0===a?void 0:a.top)||15,right:(null===(d=b.margins)||void 0===d?void 0:d.right)||15,bottom:(null===(h=b.margins)||void 0===h?void 0:h.bottom)||15,left:(null===(u=b.margins)||void 0===u?void 0:u.left)||15},P=t.scrollTop,(_=t.cloneNode(!0)).style.position="absolute",_.style.left="-9999px",_.style.overflow="visible",_.style.height="auto",S?(D=("landscape"===w?"A4"===C?297:279:"A4"===C?210:216)-F.left-F.right,M="landscape"===w?4:3.78,N=Math.floor(D*M),_.style.width=N+"px",_.style.maxWidth=N+"px",_.querySelectorAll("table").forEach((function(t){var e=t;(e.style.width="100%",e.style.tableLayout="fixed","landscape"===w)&&e.querySelectorAll("td, th").forEach((function(t){t.style.padding="3px 4px"}))}))):(_.style.width=t.clientWidth+"px",console.log("使用缩放模式，保持原始宽度:",t.clientWidth+"px")),document.body.appendChild(_),R=_.querySelector(".ddr-report-header"),O=_.querySelector(".ddr-report-footer"),(T=_.querySelector(".ddr-table-container"))||console.warn("未找到表格容器元素，导出可能不完整"),T&&(T.style.maxHeight="none",T.style.height="auto",T.style.overflow="visible",(J=T.querySelector("table"))&&(J.style.width="100%",J.querySelectorAll("td, th").forEach((function(t){t.style.border="1px solid #ddd"})))),R&&(R.style.position="relative",R.style.height="auto",R.style.overflow="visible"),O&&(O.style.position="relative",O.style.height="auto",O.style.overflow="visible"),function(t){try{t.setFont("helvetica");var e=t.text;return t.text=function(t,o,r,n){try{return e.call(this,function(t){try{return t.replace(/：/g,":").replace(/，/g,",").replace(/。/g,".").replace(/（/g,"(").replace(/）/g,")").replace(/；/g,";")}catch(e){return t}}(t),o,r,n)}catch(i){console.warn("文字渲染失败:",i);var a=t.replace(/[^\x00-\x7F]/g,"?");return e.call(this,a,o,r,n)}},t}catch(e){return console.warn("中文支持设置失败:",e),t}}(k=new o.jsPDF({orientation:w,unit:"mm",format:C})),z=k.internal.pageSize.getWidth(),j=k.internal.pageSize.getHeight(),L=j-F.top-F.bottom,q=z-F.left-F.right,k.setFontSize(12),!x)return[3,13];if(A=0,I=void 0,!R)return[3,4];s.label=1;case 1:return s.trys.push([1,3,,4]),B=R.getBoundingClientRect(),console.log("📏 报表头DOM尺寸：".concat(Math.round(B.width),"px × ").concat(Math.round(B.height),"px")),[4,i.default(R,{scale:2,useCORS:!0,logging:!1,allowTaint:!0,backgroundColor:"#FFFFFF"})];case 2:return I=s.sent(),A=I.height/I.width*q,console.log("📏 报表头Canvas尺寸：".concat(I.width,"px × ").concat(I.height,"px")),console.log("📏 报表头实际高度：".concat(Math.round(100*A)/100,"mm")),[3,4];case 3:return H=s.sent(),console.warn("渲染表头时出错:",H),[3,4];case 4:if(V=0,W=void 0,!O)return[3,8];s.label=5;case 5:return s.trys.push([5,7,,8]),G=O.getBoundingClientRect(),console.log("📏 报表尾DOM尺寸：".concat(Math.round(G.width),"px × ").concat(Math.round(G.height),"px")),[4,i.default(O,{scale:2,useCORS:!0,logging:!1,allowTaint:!0,backgroundColor:"#FFFFFF"})];case 6:return W=s.sent(),V=W.height/W.width*q,console.log("📏 报表尾Canvas尺寸：".concat(W.width,"px × ").concat(W.height,"px")),console.log("📏 报表尾实际高度：".concat(Math.round(100*V)/100,"mm")),[3,8];case 7:return U=s.sent(),console.warn("渲染表尾时出错:",U),[3,8];case 8:if(!(J=(null==T?void 0:T.querySelector("table"))||T))throw new Error("找不到表格元素");Y=J.getBoundingClientRect(),console.log("📏 表格DOM尺寸：".concat(Math.round(Y.width),"px × ").concat(Math.round(Y.height),"px")),X=void 0,K=void 0,$=void 0,s.label=9;case 9:return s.trys.push([9,11,,13]),[4,i.default(J,{scale:2,useCORS:!0,logging:!1,allowTaint:!0,backgroundColor:"#FFFFFF"})];case 10:for(X=s.sent(),K=q,$=X.height/X.width*K,console.log("📏 表格Canvas尺寸：".concat(X.width,"px × ").concat(X.height,"px")),console.log("📏 表格实际高度：".concat(Math.round(100*$)/100,"mm")),Q=J.querySelectorAll("tr"),Z=Q.length,tt=0,et=0;et<Q.length&&Q[et].querySelector("th");et++)tt++;for(ot=Z-tt,console.log("总行数: ".concat(Z,", 表头行数: ").concat(tt,", 数据行数: ").concat(ot)),rt=[],console.log("🔍 开始精确测量各部分实际高度..."),nt=0,I&&(nt=A,console.log("📏 报表头实际高度：".concat(Math.round(nt),"mm"))),at=0,W&&(at=V,console.log("📏 报表尾实际高度：".concat(Math.round(at),"mm"))),it=X.height/Z,lt=it/X.height*$,console.log("📏 单行数据高度：".concat(Math.round(100*lt)/100,"mm")),console.log("🔍 精确高度计算："),console.log("- 页面总高度：".concat(Math.round(j),"mm")),console.log("- 上下边距：".concat(F.top+F.bottom,"mm")),console.log("- 第一页页码预留：".concat(25,"mm")),console.log("- 中间页页码预留：".concat(18,"mm")),console.log("- 报表头高度：".concat(Math.round(nt),"mm")),console.log("- 单行数据高度：".concat(Math.round(100*lt)/100,"mm")),console.log("- 报表尾高度：".concat(Math.round(at),"mm")),ct=j-F.top-F.bottom-25-8,st=j-F.top-F.bottom-18-8,dt=ct-nt-5,ht=st,ut=st-at-10,console.log("📐 各页可用数据高度："),console.log("- 第一页数据区：".concat(Math.round(dt),"mm")),console.log("- 中间页数据区：".concat(Math.round(ht),"mm")),console.log("- 最后页数据区：".concat(Math.round(ut),"mm")),ft=Math.floor(dt/lt),mt=Math.floor(ht/lt),gt=Math.floor(ut/lt),console.log("📊 精确计算的各页最大行数："),console.log("- 第一页最大：".concat(ft,"行 (").concat(Math.round(dt),"mm ÷ ").concat(Math.round(100*lt)/100,"mm)")),console.log("- 中间页最大：".concat(mt,"行 (").concat(Math.round(ht),"mm ÷ ").concat(Math.round(100*lt)/100,"mm)")),console.log("- 最后页最大：".concat(gt,"行 (").concat(Math.round(ut),"mm ÷ ").concat(Math.round(100*lt)/100,"mm)")),pt=0,vt=0;pt<ot;)yt=void 0,0===vt?yt=ft:(bt=ot-pt)<=gt?(yt=bt,console.log("📄 第".concat(vt+1,"页为最后一页，显示剩余").concat(bt,"行，报表尾将在此页或新页显示"))):yt=mt,Lt=Math.min(yt,ot-pt),(pt+=Lt)<ot&&(wt=(qt=nt/$)+(Ct=pt/ot)*(At=1-qt-at/$),rt.push({yPercent:wt,endRow:pt}),console.log("📄 创建分页点 ".concat(vt+1,"：第").concat(pt,"行结束，Y=").concat(Math.round(100*wt),"% (头部").concat(Math.round(100*qt),"% + 数据").concat(Math.round(Ct*At*100),"%)"))),vt++;for(Et=rt.length+1,console.log("📊 总计需要 ".concat(Et," 页显示 ").concat(ot," 行数据")),xt=I?I.toDataURL("image/jpeg",E):null,(St=W?W.toDataURL("image/jpeg",E):null)&&(Ft=rt.length>0?ot-rt[rt.length-1].endRow:ot,_t=ut-(Pt=Ft*lt),console.log("📋 报表尾检查："),console.log("- 最后一页数据行数：".concat(Ft)),console.log("- 最后一页数据占用高度：".concat(Math.round(Pt),"mm")),console.log("- 最后一页剩余高度：".concat(Math.round(_t),"mm")),console.log("- 报表尾需要高度：".concat(Math.round(at+10),"mm")),_t<at+10?console.log("⚠️ 最后一页空间不足，报表尾将在新页显示"):console.log("✅ 最后一页空间充足，报表尾将在当前页显示")),Dt=0;Dt<Et;Dt++){Dt>0&&k.addPage(),Mt=F.top,xt&&0===Dt&&(k.addImage(xt,"JPEG",F.left,Mt,q,A),Mt+=A+5),Nt=0,Rt=1,rt.length>0?0===Dt?(Nt=0,Rt=rt[0].yPercent,jt=rt[0].endRow,console.log("📄 第1页：显示表头+第1-".concat(jt,"行，Y范围：0% 到 ").concat(Math.round(100*rt[0].yPercent),"%"))):(Nt=rt[Dt-1].yPercent,Rt=Dt<rt.length?rt[Dt].yPercent:1,zt=rt[Dt-1].endRow+1,jt=Dt<rt.length?rt[Dt].endRow:ot,console.log("📄 第".concat(Dt+1,"页：显示第").concat(zt,"-").concat(jt,"行，Y范围：").concat(Math.round(100*Nt),"% 到 ").concat(Math.round(100*Rt),"%"))):console.log("📄 第".concat(Dt+1,"页：显示所有内容（单页模式）")),Ot=void 0,Tt=void 0,kt=void 0,rt.length>0?0===Dt?(jt=rt[0].endRow,Ot=0,Bt=(qt=nt/$)+jt/ot*(At=1-qt-at/$),Tt=Math.floor(Bt*X.height),kt=Tt/X.height*$,console.log("📐 第1页精确裁剪：表头+".concat(jt,"行数据，源高度=").concat(Math.round(Tt),"px，目标高度=").concat(Math.round(kt),"mm，结束比例=").concat(Math.round(100*Bt),"%"))):(zt=rt[Dt-1].endRow,jt=Dt<rt.length?rt[Dt].endRow:ot,Lt=jt-zt,It=(qt=nt/$)+zt/ot*(At=1-qt-at/$),Bt=qt+jt/ot*At,Ot=Math.floor(It*X.height),Tt=Math.floor((Bt-It)*X.height),kt=Tt/X.height*$,console.log("📐 第".concat(Dt+1,"页精确裁剪：第").concat(zt+1,"-").concat(jt,"行（").concat(Lt,"行），源高度=").concat(Math.round(Tt),"px，目标高度=").concat(Math.round(kt),"mm，范围=").concat(Math.round(100*It),"%-").concat(Math.round(100*Bt),"%"))):(Ot=Math.floor(Nt*X.height),Tt=Math.ceil((Rt-Nt)*X.height),kt=Tt/X.height*$,console.log("📐 单页模式：源高度=".concat(Math.round(Tt),"px，目标高度=").concat(Math.round(kt),"mm"))),Ht=j-Mt-F.bottom-15,kt>Ht&&console.warn("⚠️ 第".concat(Dt+1,"页内容高度").concat(Math.round(kt),"mm超出可用空间").concat(Math.round(Ht),"mm，可能需要调整分页算法"));try{(Vt=document.createElement("canvas")).width=X.width,Vt.height=Tt,(Wt=Vt.getContext("2d"))&&(Wt.drawImage(X,0,Ot,X.width,Tt,0,0,Vt.width,Vt.height),Gt=Vt.toDataURL("image/jpeg",E),k.addImage(Gt,"JPEG",F.left,Mt,q,kt),Mt+=kt)}catch(t){console.warn("处理表格页码时出错:",t)}if(Et>1)try{k.setFontSize(10),k.setTextColor(80,80,80),Kt=j-F.bottom+3,k.text("Page ".concat(Dt+1," / ").concat(Et),z/2,Kt,{align:"center"}),console.log("第".concat(Dt+1,"页添加页码，位置：Y=").concat(Math.round(Kt),"mm"))}catch(t){console.warn("页码渲染失败:",t)}if(St&&Dt===Et-1)if(Ut=Mt+10,Jt=j-F.bottom-15-V,(Yt=Math.max(Ut,Jt))+V>j-F.bottom-15){if(console.log("📄 表尾需要新页显示，当前页剩余空间不足"),k.addPage(),k.addImage(St,"JPEG",F.left,F.top,q,V),Et>1&&(Xt=Et+1,k.setFontSize(10),k.setTextColor(80,80,80),Kt=j-F.bottom+3,k.text("Page ".concat(Xt," / ").concat(Xt),z/2,Kt,{align:"center"})),g)try{(Zt=document.createElement("canvas")).width=400,Zt.height=100,(te=Zt.getContext("2d"))&&(te.font="40px Arial, sans-serif",te.fillStyle="rgba(200, 200, 200, 0.3)",te.textAlign="center",te.textBaseline="middle",te.translate(200,50),te.rotate(45*Math.PI/180),te.fillText(g,0,0),ee=Zt.toDataURL("image/png"),k.addImage(ee,"PNG",z/2-50,j/2-12.5,100,25,void 0,"NONE"))}catch(t){console.warn("新页水印添加失败:",t)}}else console.log("📄 在第".concat(Dt+1,"页添加表尾，位置：Y=").concat(Math.round(Yt),"mm")),k.addImage(St,"JPEG",F.left,Yt,q,V);if(g)try{k.setTextColor(200,200,200),k.setFontSize(40),$t=z/2,Qt=j/2;try{if((Zt=document.createElement("canvas")).width=400,Zt.height=100,!(te=Zt.getContext("2d")))throw new Error("无法创建canvas上下文");te.font="40px Arial, sans-serif",te.fillStyle="rgba(200, 200, 200, 0.3)",te.textAlign="center",te.textBaseline="middle",te.translate(200,50),te.rotate(45*Math.PI/180),te.fillText(g,0,0),ee=Zt.toDataURL("image/png"),k.addImage(ee,"PNG",$t-50,Qt-12.5,100,25,void 0,"NONE"),console.log("第".concat(Dt+1,'页添加水印图像: "').concat(g,'"'))}catch(t){console.warn("Canvas水印失败，使用文字水印:",t);try{k.text("CONFIDENTIAL",$t,Qt,{align:"center",baseline:"middle",angle:45}),console.log("第".concat(Dt+1,'页添加英文水印: "CONFIDENTIAL"'))}catch(t){console.warn("文字水印也失败:",t)}}}catch(t){console.warn("第".concat(Dt+1,"页添加水印失败:"),t)}}return[3,13];case 11:return oe=s.sent(),console.warn("处理表格时出错:",oe),[4,i.default(_,{scale:1.5,useCORS:!0,logging:!1,allowTaint:!0,backgroundColor:"#FFFFFF"})];case 12:return re=s.sent(),ne=re.toDataURL("image/jpeg",E),ae=re.width/re.height,ie=q/L,le=void 0,ce=void 0,S?(le=q,ce=re.height/re.width*le,console.log("重新排版模式 - 图像尺寸:",{imgWidth:le,imgHeight:ce})):(ae>ie?ce=(le=q)/ae:le=(ce=L)*ae,console.log("缩放模式 - 等比例缩放图像尺寸:",{imgWidth:le,imgHeight:ce,canvasAspectRatio:ae,pageAspectRatio:ie})),k.addImage(ne,"JPEG",F.left,F.top,le,ce),[3,13];case 13:return document.body.removeChild(_),t.scrollTop=P,k.save("".concat(f,".pdf")),[2,Promise.resolve()];case 14:return se=s.sent(),console.error("PDF导出失败:",se),[2,Promise.reject(se)];case 15:return[2]}}))}))},t}(),g=Object.freeze({__proto__:null,Exporter:m});exports.DDR=h,exports.default=h;
//# sourceMappingURL=ddr-core.js.map
