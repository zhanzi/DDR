"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("xlsx"),e=require("html2canvas"),o=require("jspdf");function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}function r(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(o){if("default"!==o){var n=Object.getOwnPropertyDescriptor(t,o);Object.defineProperty(e,o,n.get?n:{enumerable:!0,get:function(){return t[o]}})}})),e.default=t,Object.freeze(e)}var a=r(t),i=n(e),l=function(){return l=Object.assign||function(t){for(var e,o=1,n=arguments.length;o<n;o++)for(var r in e=arguments[o])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},l.apply(this,arguments)};function c(t,e,o,n){return new(o||(o=Promise))((function(r,a){function i(t){try{c(n.next(t))}catch(t){a(t)}}function l(t){try{c(n.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(i,l)}c((n=n.apply(t,e||[])).next())}))}function s(t,e){var o,n,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=l(0),i.throw=l(1),i.return=l(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function l(l){return function(c){return function(l){if(o)throw new TypeError("Generator is already executing.");for(;i&&(i=0,l[0]&&(a=0)),a;)try{if(o=1,n&&(r=2&l[0]?n.return:l[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,l[1])).done)return r;switch(n=0,r&&(l=[2&l[0],r.value]),l[0]){case 0:case 1:r=l;break;case 4:return a.label++,{value:l[1],done:!1};case 5:a.label++,n=l[1],l=[0];continue;case 7:l=a.ops.pop(),a.trys.pop();continue;default:if(!(r=a.trys,(r=r.length>0&&r[r.length-1])||6!==l[0]&&2!==l[0])){a=0;continue}if(3===l[0]&&(!r||l[1]>r[0]&&l[1]<r[3])){a.label=l[1];break}if(6===l[0]&&a.label<r[1]){a.label=r[1],r=l;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(l);break}r[2]&&a.ops.pop(),a.trys.pop();continue}l=e.call(t,a)}catch(t){l=[6,t],n=0}finally{o=r=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,c])}}}"function"==typeof SuppressedError&&SuppressedError;var d,h=function(){function t(e){if(this.data=[],this.metadata={},this.pagination=null,this.filters={},this.eventListeners=new Map,this.formatters={},this.initialized=!1,this.options=e,"string"==typeof e.container){var o=document.querySelector(e.container);if(!o)throw new Error("找不到容器元素: ".concat(e.container));this.container=o}else{if(!(e.container instanceof HTMLElement))throw new Error("无效的容器元素");this.container=e.container}this.container.classList.add("ddr-container"),e.theme?this.container.classList.add("ddr-theme-".concat(e.theme)):this.container.classList.add("ddr-theme-default"),this.formatters=l({},t.globalFormatters),e.metadata&&(this.metadata=l({},e.metadata))}return t.create=function(e){var o=new t(e);return o.init().catch((function(t){e.onError?e.onError(t):console.error("DDR初始化失败:",t)})),o},t.registerFormatter=function(e,o){t.globalFormatters[e]=o},t.prototype.init=function(){var t;return c(this,void 0,void 0,(function(){var e,o,n;return s(this,(function(r){switch(r.label){case 0:return r.trys.push([0,3,,4]),e=this,[4,this._loadConfig(this.options.config)];case 1:return e.config=r.sent(),[4,this._fetchData(this.config.dataSource)];case 2:return o=r.sent(),this.data=o.records,this.metadata=o.metadata||this.metadata,this.pagination=o.pagination||null,(null===(t=this.config.grouping)||void 0===t?void 0:t.enabled)&&(this.data=this._processGrouping(this.data),console.log("📊 分组处理完成，数据行数：".concat(this.data.length))),this._render(),this.initialized=!0,this._emitEvent("data-loaded",{data:this.data}),this.options.onLoad&&this.options.onLoad(),[3,4];case 3:throw n=r.sent(),this._emitEvent("error",{error:n}),n;case 4:return[2]}}))}))},t.prototype.reload=function(t){var e;return c(this,void 0,void 0,(function(){var o,n;return s(this,(function(r){switch(r.label){case 0:if(!this.initialized)throw new Error("DDR尚未初始化");r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this._fetchData(this.config.dataSource,t)];case 2:return o=r.sent(),this.data=o.records,o.metadata&&(this.metadata=o.metadata,this._emitEvent("metadata-updated",{metadata:this.metadata})),this.pagination=o.pagination||null,(null===(e=this.config.grouping)||void 0===e?void 0:e.enabled)&&(this.data=this._processGrouping(this.data),console.log("📊 重新加载后分组处理完成，数据行数：".concat(this.data.length))),this._render(),this._emitEvent("data-loaded",{data:this.data}),[3,4];case 3:throw n=r.sent(),this._emitEvent("error",{error:n}),n;case 4:return[2]}}))}))},t.prototype.refreshMetadata=function(){return c(this,void 0,void 0,(function(){var t,e,o;return s(this,(function(n){switch(n.label){case 0:if(!this.initialized)throw new Error("DDR尚未初始化");n.label=1;case 1:return n.trys.push([1,6,,7]),this.config.dataSource.metadataSource?[4,this._fetchMetadata(this.config.dataSource.metadataSource)]:[3,3];case 2:return t=n.sent(),this.metadata=t.metadata||{},[3,5];case 3:return[4,this._fetchData(this.config.dataSource)];case 4:(e=n.sent()).metadata&&(this.metadata=e.metadata),n.label=5;case 5:return this._renderHeaderFooter(),this._emitEvent("metadata-updated",{metadata:this.metadata}),[3,7];case 6:throw o=n.sent(),this._emitEvent("error",{error:o}),o;case 7:return[2]}}))}))},t.prototype.updateMetadata=function(t){if(t.data&&Array.isArray(t.data)){console.log("📊 通过updateMetadata更新数据，共",t.data.length,"条记录"),this.data=t.data,t.data;var e=function(t,e){var o={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(o[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(t);r<n.length;r++)e.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(t,n[r])&&(o[n[r]]=t[n[r]])}return o}(t,["data"]);this.metadata=l(l({},this.metadata),e),this.initialized&&(this._render(),this._emitEvent("data-loaded",{data:this.data}),this._emitEvent("metadata-updated",{metadata:this.metadata}))}else this.metadata=l(l({},this.metadata),t),this.initialized&&(this._renderHeaderFooter(),this._emitEvent("metadata-updated",{metadata:this.metadata}))},t.prototype.exportTo=function(t,e){return c(this,void 0,void 0,(function(){var o,n;return s(this,(function(r){switch(r.label){case 0:if(!this.initialized)throw new Error("DDR尚未初始化");r.label=1;case 1:return r.trys.push([1,7,,8]),this._emitEvent("export-start",{type:t,options:e}),[4,Promise.resolve().then((function(){return m}))];case 2:return o=r.sent().Exporter,"excel"!==t?[3,4]:[4,o.toExcel(this.container,e)];case 3:return r.sent(),[3,6];case 4:return"pdf"!==t?[3,6]:[4,o.toPDF(this.container,this.config,e)];case 5:r.sent(),r.label=6;case 6:return this._emitEvent("export-complete",{type:t,fileName:(null==e?void 0:e.fileName)||"".concat(this.config.meta.name,".").concat("excel"===t?"xlsx":"pdf")}),[3,8];case 7:throw n=r.sent(),this._emitEvent("error",{error:n}),n;case 8:return[2]}}))}))},t.prototype.destroy=function(){this.container.innerHTML="",this.eventListeners.clear(),this.data=[],this.metadata={},this.initialized=!1},t.prototype.setFilter=function(t){this.filters=l(l({},this.filters),t)},t.prototype.on=function(t,e){this.eventListeners.has(t)||this.eventListeners.set(t,[]),this.eventListeners.get(t).push(e)},t.prototype.off=function(t,e){if(this.eventListeners.has(t)){var o=this.eventListeners.get(t),n=o.indexOf(e);-1!==n&&o.splice(n,1)}},t.prototype.print=function(){var t,e;return c(this,void 0,void 0,(function(){var o;return s(this,(function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),console.log("开始打印，使用PDF导出逻辑生成打印内容"),[4,Promise.resolve().then((function(){return m}))];case 1:return[4,n.sent().Exporter.toPrint(this.container,this.config,{watermark:null===(t=this.config.features)||void 0===t?void 0:t.watermark,pdf:(null===(e=this.config.features)||void 0===e?void 0:e.pdfConfig)||{}})];case 2:return n.sent(),[3,4];case 3:return o=n.sent(),console.error("打印失败，降级到简单打印:",o),this._simplePrint(),[3,4];case 4:return[2]}}))}))},t.prototype._simplePrint=function(){var t=document.createElement("style");t.textContent="\n      @media print {\n        body * {\n          visibility: hidden;\n        }\n        .ddr-container, .ddr-container * {\n          visibility: visible;\n        }\n        .ddr-container {\n          position: absolute;\n          left: 0;\n          top: 0;\n          width: 100% !important;\n          height: auto !important;\n          overflow: visible !important;\n        }\n        .ddr-table-container {\n          overflow: visible !important;\n          height: auto !important;\n        }\n        .ddr-table {\n          page-break-inside: auto;\n        }\n        .ddr-table-row {\n          page-break-inside: avoid;\n          page-break-after: auto;\n        }\n        .ddr-header, .ddr-footer {\n          page-break-inside: avoid;\n        }\n      }\n    ",document.head.appendChild(t),window.print(),setTimeout((function(){document.head.removeChild(t)}),100)},t.prototype.getData=function(){return function(t,e,o){if(o||2===arguments.length)for(var n,r=0,a=e.length;r<a;r++)!n&&r in e||(n||(n=Array.prototype.slice.call(e,0,r)),n[r]=e[r]);return t.concat(n||Array.prototype.slice.call(e))}([],this.data,!0)},t.prototype.getMetadata=function(){return l({},this.metadata)},t.prototype._getValueByPath=function(t){if(t)return t.split(".").reduce((function(t,e){return t&&void 0!==t[e]?t[e]:void 0}),this.metadata)},t.prototype._loadConfig=function(t){return c(this,void 0,void 0,(function(){var e,o;return s(this,(function(n){switch(n.label){case 0:return"string"!=typeof t?[3,8]:t.startsWith("http")?[4,fetch(t)]:[3,3];case 1:case 4:if(!(e=n.sent()).ok)throw new Error("加载配置失败: ".concat(e.statusText));return[4,e.json()];case 2:case 5:return[2,n.sent()];case 3:return n.trys.push([3,6,,7]),[4,fetch(t)];case 6:throw o=n.sent(),new Error("加载配置失败: ".concat(o instanceof Error?o.message:String(o)));case 7:return[3,9];case 8:return[2,t];case 9:return[2]}}))}))},t.prototype._fetchData=function(t,e){return c(this,void 0,void 0,(function(){var o,n,r,a,i,c;return s(this,(function(s){switch(s.label){case 0:return t.data&&Array.isArray(t.data)?(console.log("📊 使用直接提供的数据，共",t.data.length,"条记录"),[2,{records:t.data,metadata:this.metadata}]):!t.mock||this.options.debug&&"localhost"!==window.location.hostname?t.api?(o=l(l(l({},t.params),this.filters),e),"POST"===(n={method:t.method||"GET",headers:l({"Content-Type":"application/json"},t.headers||{})}).method&&(n.body=JSON.stringify(o)),r=t.api,"GET"===n.method&&Object.keys(o).length>0&&(a=new URLSearchParams,Object.entries(o).forEach((function(t){var e=t[0],o=t[1];a.append(e,String(o))})),r+="?".concat(a.toString())),[4,fetch(r,n)]):(console.warn("⚠️ 未配置API地址且未提供直接数据，返回空数据集"),[2,{records:[],metadata:this.metadata}]):(console.log("📊 使用模拟数据，共",t.mock.length,"条记录"),[2,{records:t.mock,metadata:this.metadata}]);case 1:if(!(i=s.sent()).ok)throw new Error("API请求失败: ".concat(i.statusText));return[4,i.json()];case 2:if(!(c=s.sent()).success)throw new Error("API错误: ".concat(c.message||"状态码 ".concat(c.code)));return[2,{records:c.data.records||[],metadata:c.data.metadata,pagination:c.data.pagination}]}}))}))},t.prototype._fetchMetadata=function(t){return c(this,void 0,void 0,(function(){var e,o,n,r,a;return s(this,(function(i){switch(i.label){case 0:if(!t)throw new Error("未配置元数据源");return"POST"===(e={method:t.method||"GET",headers:{"Content-Type":"application/json"}}).method&&t.params&&(e.body=JSON.stringify(t.params)),o=t.api,"GET"===e.method&&t.params&&Object.keys(t.params).length>0&&(n=new URLSearchParams,Object.entries(t.params).forEach((function(t){var e=t[0],o=t[1];n.append(e,String(o))})),o+="?".concat(n.toString())),[4,fetch(o,e)];case 1:if(!(r=i.sent()).ok)throw new Error("元数据API请求失败: ".concat(r.statusText));return[4,r.json()];case 2:if(!(a=i.sent()).success)throw new Error("元数据API错误: ".concat(a.message||"状态码 ".concat(a.code)));return[2,{metadata:a.data.metadata||{}}]}}))}))},t.prototype._render=function(){var t;this.container.innerHTML="";var e=document.createElement("div");e.className="ddr-wrapper",this.config.layout&&(this.config.layout.height&&(e.style.height="number"==typeof this.config.layout.height?"".concat(this.config.layout.height,"px"):this.config.layout.height),this.config.layout.bordered&&e.classList.add("ddr-bordered")),this.container.appendChild(e);var o=this._determineRenderMode();e.setAttribute("data-render-mode",o),this._renderHeaderFooter(e),"canvas"===o?this._renderCanvas(e):this._renderDOM(e),(null===(t=this.config.features)||void 0===t?void 0:t.watermark)&&this._addWatermark(e,this.config.features.watermark),this._emitEvent("render-complete")},t.prototype._renderHeaderFooter=function(t){var e=t||this.container.querySelector(".ddr-wrapper");if(e){var o=e.querySelector(".ddr-report-header"),n=e.querySelector(".ddr-report-footer");if(o&&e.removeChild(o),n&&e.removeChild(n),this.config.header){var r=this._createHeader(this.config.header);if(r){e.insertBefore(r,e.firstChild),new ResizeObserver((function(t){for(var o=0,n=t;o<n.length;o++){var r=n[o].contentRect.height;e.style.setProperty("--header-height","".concat(r,"px"));var a=e.querySelector(".ddr-table-container");a&&(a.style.marginTop="10px",a.style.maxHeight="calc(100% - ".concat(r+10,"px - var(--footer-height, 0px))"))}})).observe(r);var a=r.getBoundingClientRect().height;e.style.setProperty("--header-height","".concat(a,"px")),(i=e.querySelector(".ddr-table-container"))&&(i.style.marginTop="10px",i.style.maxHeight="calc(100% - ".concat(a+10,"px - var(--footer-height, 0px))"))}}if(this.config.footer&&this.initialized){var i,l=this._createFooter(this.config.footer);if(l)(i=e.querySelector(".ddr-table-container"))?e.insertBefore(l,i.nextSibling):e.appendChild(l)}}},t.prototype._createHeader=function(t){var e=this;if(!t)return null;var o=document.createElement("div");o.className="ddr-report-header",o.style.minHeight="".concat(t.height||80,"px");var n=document.createElement("div");if(n.className="ddr-header-top",t.logo){var r=document.createElement("div");r.className="ddr-header-logo ddr-header-logo-".concat(t.logo.position||"left");var a=document.createElement("img");a.alt="Logo",a.src=t.logo.metadataKey?this._getValueByPath(t.logo.metadataKey)||t.logo.url||"":t.logo.url||"",t.logo.width&&(a.width=t.logo.width),t.logo.height&&(a.height=t.logo.height),r.appendChild(a),n.appendChild(r)}var i=document.createElement("div");if(i.className="ddr-header-center",t.title){var l="string"==typeof t.title?t.title:t.title.metadataPath&&this._getValueByPath(t.title.metadataPath)||t.title.text,c=document.createElement("h2");c.className="ddr-header-title",c.textContent=l,"object"==typeof t.title&&t.title.style&&Object.assign(c.style,t.title.style),i.appendChild(c)}if(t.subtitle){var s=document.createElement("div");s.className="ddr-header-subtitle";var d="";if("string"==typeof t.subtitle)d=t.subtitle;else if("object"==typeof t.subtitle&&null!==t.subtitle){var h;d=(h=t.subtitle).text||String(t.subtitle)}else d=String(t.subtitle);if(s.textContent=d,"object"==typeof t.subtitle&&null!==t.subtitle)(h=t.subtitle).style&&Object.assign(s.style,h.style);i.appendChild(s)}if(n.appendChild(i),o.appendChild(n),t.fields&&t.fields.length>0){var u=document.createElement("div");u.className="ddr-header-fields";var f=document.createElement("div");f.className="ddr-header-fields-left";var p=document.createElement("div");p.className="ddr-header-fields-right",t.fields.forEach((function(t){var o=document.createElement("div");o.className="ddr-header-field";var n=document.createElement("span");n.className="ddr-field-label",n.textContent=t.label||"",o.appendChild(n);var r=document.createElement("span");r.className="ddr-field-value";var a=t.metadataPath?e._getValueByPath(t.metadataPath):t.value||"";void 0!==a&&t.formatter&&e.formatters[t.formatter]&&(a=e.formatters[t.formatter](a)),r.textContent=void 0!==a?String(a):"",o.appendChild(r),t.style&&Object.assign(o.style,t.style),"right"===t.position?p.appendChild(o):f.appendChild(o)})),u.appendChild(f),u.appendChild(p),o.appendChild(u)}return o},t.prototype._createFooter=function(t){var e=this;if(!t)return null;var o=document.createElement("div");if(o.className="ddr-report-footer",o.style.minHeight="".concat(t.height||100,"px"),t.fixed&&o.classList.add("ddr-footer-fixed"),t.summary&&t.summary.length>0){var n=document.createElement("div");n.className="ddr-footer-summary",t.summary.forEach((function(t){var o=document.createElement("div");o.className="ddr-summary-item";var r=document.createElement("span");r.className="ddr-summary-label",r.textContent="".concat(t.column,"合计:");var a,i=document.createElement("span");i.className="ddr-summary-value",a=t.metadataPath?e._getValueByPath(t.metadataPath):e._calculateSummary(e.data,t),t.formatter&&e.formatters[t.formatter]&&(a=e.formatters[t.formatter](a)),i.textContent=void 0!==a?String(a):"",o.appendChild(r),o.appendChild(i),n.appendChild(o)})),o.appendChild(n)}if(t.fields&&t.fields.length>0){var r=document.createElement("div");r.className="ddr-footer-fields",t.fields.forEach((function(t){var o=document.createElement("div");o.className="ddr-footer-field ddr-align-".concat(t.position||"left");var n=document.createElement("span");n.className="ddr-field-label",n.textContent=t.label||"",o.appendChild(n);var a=document.createElement("span");a.className="ddr-field-value";var i=t.metadataPath?e._getValueByPath(t.metadataPath):t.value||"";void 0!==i&&t.formatter&&e.formatters[t.formatter]&&(i=e.formatters[t.formatter](i)),a.textContent=void 0!==i?String(i):"",o.appendChild(a),t.style&&Object.assign(o.style,t.style),r.appendChild(o)})),o.appendChild(r)}if(t.signatures&&t.signatures.length>0){var a=document.createElement("div");a.className="ddr-footer-signatures",t.signatures.forEach((function(t){var o=document.createElement("div");o.className="ddr-signature-item";var n=document.createElement("div");n.className="ddr-signature-label",n.textContent=t.label||"",o.appendChild(n);var r=document.createElement("div");r.className="ddr-signature-name";var i=t.metadataPath?e._getValueByPath(t.metadataPath):t.name||"";if(r.textContent=i||"",o.appendChild(r),t.showTimestamp){var l=document.createElement("div");l.className="ddr-signature-date";var c=t.dateMetadataPath?e._getValueByPath(t.dateMetadataPath):null;c&&(l.textContent=new Date(c).toLocaleDateString()),o.appendChild(l)}t.width&&(o.style.width="".concat(t.width,"px")),a.appendChild(o)})),o.appendChild(a)}if(t.notes){var i=document.createElement("div");i.className="ddr-footer-notes",i.textContent=t.notes,o.appendChild(i)}if(t.pageInfo&&this.pagination){var l=document.createElement("div");l.className="ddr-footer-page ddr-align-".concat(t.pageInfo.position||"right");var c=t.pageInfo.format.replace("{current}",String(this.pagination.pageNumber||1)).replace("{total}",String(this.pagination.totalPages||1));l.textContent=c,o.appendChild(l)}return o},t.prototype._calculateSummary=function(t,e){if(!t.length)return 0;var o=t.map((function(t){var o=t[e.column];return"number"==typeof o?o:0}));switch(e.type){case"sum":return o.reduce((function(t,e){return t+e}),0);case"avg":return o.reduce((function(t,e){return t+e}),0)/o.length;case"count":return o.length;default:return 0}},t.prototype._processGrouping=function(t){var e=this.config.grouping;return e&&e.enabled&&t.length?(console.log("📊 开始处理分组小计，原始数据 ".concat(t.length," 行")),this._processSingleGroupSubtotals(t,{groupBy:Array.isArray(e.groupBy)?e.groupBy[0]:e.groupBy,subtotals:e.subtotals,subtotalLabel:e.subtotalLabel||"小计",showGrandTotal:!1!==e.showGrandTotal,grandTotalLabel:e.grandTotalLabel||"总计"})):t},t.prototype._processSingleGroupSubtotals=function(t,e){var o,n=this,r=e.groupBy,a=e.subtotals,i=e.subtotalLabel,c=e.showGrandTotal,s=e.grandTotalLabel;if(!t.length||!r)return t;var d={};t.forEach((function(t){var e=t[r];d[e]||(d[e]=[]),d[e].push(l(l({},t),{_rowType:"data",_level:0,_groupKey:e}))}));var h=[],u={};if(Object.keys(d).forEach((function(t){var e,o=d[t];h.push.apply(h,o);var l=((e={})[r]="".concat(t," ").concat(i),e._rowType="subtotal",e._level=1,e._groupKey=t,e._isSubtotal=!0,e);n.config.columns.map((function(t){return t.key})).forEach((function(t){t!==r&&(l[t]=null)})),a.forEach((function(t){var e=t.field,r=t.type,a=void 0===r?"sum":r,i=n._calculateGroupSummary(o,e,a);l[e]=i,c&&null!==i&&(u[e]||(u[e]={type:a,values:[]}),u[e].values.push(i))})),h.push(l)})),c&&a.length>0){var f=((o={})[r]=s,o._rowType="total",o._level=0,o._isGrandTotal=!0,o);this.config.columns.map((function(t){return t.key})).forEach((function(t){t!==r&&(f[t]=null)})),a.forEach((function(e){var o=e.field,r=e.type,a=void 0===r?"sum":r;if(u[o]){var i=u[o].values;f[o]="sum"===a?i.reduce((function(t,e){return t+e}),0):n._calculateGroupSummary(t,o,a)}})),h.push(f)}return h},t.prototype._calculateGroupSummary=function(t,e,o){if(!t.length)return null;var n,r=t.map((function(t){var o=t[e];return"number"==typeof o?o:parseFloat(o)||0})).filter((function(t){return!isNaN(t)}));if(!r.length)return null;switch(o.toLowerCase()){case"sum":n=r.reduce((function(t,e){return t+e}),0);break;case"avg":n=r.reduce((function(t,e){return t+e}),0)/r.length;break;case"count":n=r.length;break;case"max":n=Math.max.apply(Math,r);break;case"min":n=Math.min.apply(Math,r);break;default:n=0}return isNaN(n)||!isFinite(n)?null:n},t.prototype._applyGroupingStyles=function(t,e,o){var n,r,a,i=this.config.grouping;if(i&&e._rowType){var l=this._getDefaultGroupingStyles();if("subtotal"===e._rowType){var c=(null===(n=i.styles)||void 0===n?void 0:n.subtotalRow)||l.subtotal;Object.assign(t.style,c),t.classList.add("ddr-subtotal-cell")}else if("total"===e._rowType){var s=(null===(r=i.styles)||void 0===r?void 0:r.totalRow)||l.total;Object.assign(t.style,s),t.classList.add("ddr-total-cell")}else if("data"===e._rowType){var d=Array.isArray(i.groupBy)?i.groupBy[0]:i.groupBy;o.key===d&&(null===(a=i.styles)||void 0===a?void 0:a.groupColumn)&&Object.assign(t.style,i.styles.groupColumn)}}},t.prototype._getDefaultGroupingStyles=function(){return{subtotal:{fontWeight:"bold",backgroundColor:"#f5f5f5",borderTop:"1px solid #d9d9d9"},total:{fontWeight:"bold",backgroundColor:"#e6f7ff",color:"#1890ff",borderTop:"2px solid #1890ff"},groupColumn:{fontWeight:"500"}}},t.prototype._determineRenderMode=function(){return"dom"===this.options.mode||"canvas"===this.options.mode?this.options.mode:this.data.length>5e3?"canvas":"dom"},t.prototype._renderDOM=function(t){var e,o=document.createElement("div");o.className="ddr-table-container";var n=t.querySelector(".ddr-report-header");if(n)if(window.ResizeObserver){new ResizeObserver((function(e){for(var r=0,a=e;r<a.length;r++){var i=a[r];if(i.target===n){var l=i.contentRect.height;t.style.setProperty("--header-height","".concat(l,"px")),t.style.setProperty("--table-offset-top","".concat(l,"px")),o.style.marginTop="20px"}}})).observe(n)}else{var r=function(){var e=n.getBoundingClientRect().height;t.style.setProperty("--header-height","".concat(e,"px")),t.style.setProperty("--table-offset-top","".concat(e,"px")),o.style.marginTop="20px"};r(),window.addEventListener("resize",r)}var a=document.createElement("div");a.className="ddr-table-wrapper";var i=document.createElement("table");i.className="ddr-table",this.config.layout&&(this.config.layout.stripe&&i.classList.add("ddr-table-stripe"),this.config.layout.hover&&i.classList.add("ddr-table-hover"));var l=this._createTableHeader(this.config.columns);i.appendChild(l);var c=this._createTableBody(this.config.columns,this.data);if(i.appendChild(c),a.appendChild(i),o.appendChild(a),t.appendChild(o),(null===(e=this.config.features)||void 0===e?void 0:e.pagination)&&this.pagination){var s=this._createPagination(this.pagination);t.appendChild(s)}if(this.config.footer){var d=this._createFooter(this.config.footer);d&&t.appendChild(d)}},t.prototype._renderCanvas=function(t){var e=document.createElement("div");e.className="ddr-canvas-placeholder",e.textContent="使用Canvas模式渲染".concat(this.data.length,"行数据"),t.appendChild(e),console.log("实际项目中需要实现Canvas渲染引擎")},t.prototype._createTableHeader=function(t){var e=document.createElement("thead");e.className="ddr-thead";var o=this._calculateHeaderRowCount(t),n=Array(o).fill(null).map((function(){var t=document.createElement("tr");return t.className="ddr-header-row",t}));return this._fillHeaderCells(t,n,0,0),n.forEach((function(t){e.appendChild(t)})),e},t.prototype._calculateHeaderRowCount=function(t){var e=1,o=function(t,n){void 0===n&&(n=1),t.forEach((function(t){t.children&&t.children.length&&(e=Math.max(e,n+1),o(t.children,n+1))}))};return o(t),e},t.prototype._fillHeaderCells=function(t,e,o,n){var r=this,a=n;return t.forEach((function(t){var n=document.createElement("th");if(n.className="ddr-header-cell",n.textContent=t.title,t.align&&(n.style.textAlign=t.align),t.width&&(n.style.width="number"==typeof t.width?"".concat(t.width,"px"):t.width),t.children&&t.children.length){var i=r._fillHeaderCells(t.children,e,o+1,a);n.colSpan=i,n.rowSpan=1,a+=i}else n.colSpan=1,n.rowSpan=e.length-o,a+=1;e[o].appendChild(n)})),a-n},t.prototype._createTableBody=function(t,e){var o,n=this,r=document.createElement("tbody");r.className="ddr-tbody";var a=this._getFlatColumns(t),i=new Map;if(!e.length){var l=document.createElement("tr");l.className="ddr-empty-row";var c=document.createElement("td");return c.className="ddr-empty-cell",c.colSpan=a.length,c.textContent=(null===(o=this.config.features)||void 0===o?void 0:o.emptyText)||"暂无数据",l.appendChild(c),r.appendChild(l),r}return e.forEach((function(t,o){var l,c=document.createElement("tr");c.className="ddr-body-row",c.setAttribute("data-index",String(o)),t._rowType&&c.setAttribute("data-row-type",t._rowType),(null===(l=n.config.layout)||void 0===l?void 0:l.rowHeight)&&(c.style.height="number"==typeof n.config.layout.rowHeight?"".concat(n.config.layout.rowHeight,"px"):n.config.layout.rowHeight);var s=0;a.forEach((function(r){var a,l,d;if(!1!==r.visible){var h="".concat(o,"-").concat(s);if(i.has(h)&&0===(null===(a=i.get(h))||void 0===a?void 0:a.rowSpan))s++;else{var u=document.createElement("td");u.className="ddr-body-cell";var f=t[r.key];if(r.formatter)if("string"==typeof r.formatter&&n.formatters[r.formatter])f=n.formatters[r.formatter](f);else if("object"==typeof r.formatter){var p=n.formatters[r.formatter.type];p&&(f=p(f,r.formatter.params))}null==f||"number"==typeof f&&isNaN(f)?u.textContent="":u.textContent=String(f),r.align&&(u.style.textAlign=r.align),"vertical"!==r.merge&&!0!==r.merge||n._handleCellMerge(u,t,r,o,s,e,i),(null===(l=n.config.grouping)||void 0===l?void 0:l.enabled)&&n._applyGroupingStyles(u,t,r),(null===(d=r.style)||void 0===d?void 0:d.conditional)&&r.style.conditional.forEach((function(e){var o=t[r.key];try{n._evaluateCondition(e.when,{value:o,row:t})&&Object.assign(u.style,e.style)}catch(t){console.error("条件解析错误:",t)}})),c.appendChild(u),s++}}})),r.appendChild(c)})),r},t.prototype._handleCellMerge=function(t,e,o,n,r,a,i){console.log('🔄 处理列 "'.concat(o.key,'" 的合并，当前行 ').concat(n,'，值: "').concat(e[o.key],'"'));for(var l=e[o.key],c=1,s=n+1;s<a.length;s++){var d=a[s][o.key];if(d!==l){console.log("  ❌ 值不同，行 ".concat(s,'，值: "').concat(d,'" !== "').concat(l,'"，停止合并'));break}c++;var h="".concat(s,"-").concat(r);i.set(h,{rowSpan:0,colSpan:0}),console.log("  ✅ 找到相同值，行 ".concat(s,'，值: "').concat(d,'"，rowSpan: ').concat(c))}c>1?(t.rowSpan=c,console.log('🎯 列 "'.concat(o.key,'" 第 ').concat(n," 行设置 rowSpan = ").concat(c))):console.log('📝 列 "'.concat(o.key,'" 第 ').concat(n," 行无需合并"))},t.prototype._evaluateCondition=function(t,e){try{var o=t,n=(o=o.replace(/value/g,JSON.stringify(e.value))).match(/row\.\w+/g);return n&&n.forEach((function(t){var n=t.split(".")[1];o=o.replace(t,JSON.stringify(e.row[n]))})),new Function("return ".concat(o))()}catch(e){return console.error("条件解析错误:",e,t),!1}},t.prototype._getFlatColumns=function(t){var e=[],o=function(t){t.forEach((function(t){t.children&&t.children.length?o(t.children):e.push(t)}))};return o(t),e},t.prototype._createPagination=function(t){var e=this,o=document.createElement("div");o.className="ddr-pagination";var n=document.createElement("span");n.className="ddr-pagination-info",n.textContent="第".concat(t.pageNumber||1,"页/共").concat(t.totalPages||1,"页"),o.appendChild(n);var r=document.createElement("button");r.className="ddr-pagination-prev",r.textContent="上一页",r.disabled=(t.pageNumber||1)<=1,r.onclick=function(){e.reload(l(l({},e.filters),{pageNumber:(t.pageNumber||1)-1}))},o.appendChild(r);for(var a=t.totalPages||1,i=t.pageNumber||1,c=Math.max(1,i-2),s=Math.min(a,c+4),d=function(t){var n=document.createElement("button");n.className="ddr-pagination-page".concat(t===i?" active":""),n.textContent=String(t),n.onclick=function(){t!==i&&e.reload(l(l({},e.filters),{pageNumber:t}))},o.appendChild(n)},h=c=Math.max(1,s-4);h<=s;h++)d(h);var u=document.createElement("button");u.className="ddr-pagination-next",u.textContent="下一页",u.disabled=(t.pageNumber||1)>=(t.totalPages||1),u.onclick=function(){e.reload(l(l({},e.filters),{pageNumber:(t.pageNumber||1)+1}))},o.appendChild(u);var f=document.createElement("select");return f.className="ddr-pagination-size",[10,20,50,100].forEach((function(e){var o=document.createElement("option");o.value=String(e),o.textContent="".concat(e,"条/页"),o.selected=e===(t.pageSize||20),f.appendChild(o)})),f.onchange=function(t){var o=Number(t.target.value);e.reload(l(l({},e.filters),{pageSize:o,pageNumber:1}))},o.appendChild(f),o},t.prototype._addWatermark=function(t,e){var o=this,n=t.querySelector(".ddr-watermark");n&&t.removeChild(n);var r=document.createElement("div");r.className="ddr-watermark",r.style.zIndex="10",e.includes("${")&&(e=e.replace(/\${([^}]+)}/g,(function(t,e){return String(o._getValueByPath(e)||t)})));for(var a=0;a<20;a++){var i=document.createElement("div");i.className="ddr-watermark-content",i.textContent=e,i.style.opacity="0.2",i.style.color="rgba(0, 0, 0, 0.25)",i.style.fontSize="18px",r.appendChild(i)}Object.defineProperty(r.style,"pointerEvents",{value:"none",writable:!1}),t.appendChild(r),new MutationObserver((function(e){e.forEach((function(e){if("childList"===e.type&&Array.from(e.removedNodes).some((function(t){return t===r||t instanceof Element&&t.querySelector(".ddr-watermark")}))&&!t.contains(r)){var o=r.cloneNode(!0);setTimeout((function(){return t.appendChild(o)}),100)}"attributes"!==e.type||e.target!==r||"style"!==e.attributeName&&"class"!==e.attributeName||(r.className="ddr-watermark",r.style.zIndex="10",r.style.opacity="0.8")}))})).observe(t,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]})},t.prototype._prepareExportData=function(t){var e,o,n,r,a,i,l,c,s,d,h,u,f=this,p=this._getFlatColumns(this.config.columns).filter((function(e){return!1!==e.visible&&((null==t?void 0:t.includeHidden)||!1!==e.visible)})),m=[];if(!1!==(null==t?void 0:t.includeHeader)&&!1!==(null===(e=this.config.header)||void 0===e?void 0:e.showOnExport)){if(null===(o=this.config.header)||void 0===o?void 0:o.title){var g="string"==typeof this.config.header.title?this.config.header.title:this.config.header.title.text;m.push([g]),m.push([])}(null===(r=null===(n=this.config.header)||void 0===n?void 0:n.fields)||void 0===r?void 0:r.length)&&(this.config.header.fields.forEach((function(t){var e=t.metadataPath?f._getValueByPath(t.metadataPath):t.value||"";m.push(["".concat(t.label||""),e])})),m.push([]))}var v=p.map((function(t){return t.title}));if(m.push(v),this.data.forEach((function(t){var e=p.map((function(e){var o=t[e.key];if(e.formatter)if("string"==typeof e.formatter&&f.formatters[e.formatter])o=f.formatters[e.formatter](o);else if("object"==typeof e.formatter){var n=f.formatters[e.formatter.type];n&&(o=n(o,e.formatter.params))}return o}));m.push(e)})),!1!==(null==t?void 0:t.includeFooter)&&!1!==(null===(a=this.config.footer)||void 0===a?void 0:a.showOnExport)){if(m.push([]),(null===(l=null===(i=this.config.footer)||void 0===i?void 0:i.summary)||void 0===l?void 0:l.length)&&(this.config.footer.summary.forEach((function(t){var e;e=t.metadataPath?f._getValueByPath(t.metadataPath):f._calculateSummary(f.data,t),t.formatter&&f.formatters[t.formatter]&&(e=f.formatters[t.formatter](e)),m.push(["".concat(t.column,"合计:"),e])})),m.push([])),(null===(s=null===(c=this.config.footer)||void 0===c?void 0:c.fields)||void 0===s?void 0:s.length)&&this.config.footer.fields.forEach((function(t){var e=t.metadataPath?f._getValueByPath(t.metadataPath):t.value||"";m.push([t.label||"",e])})),null===(h=null===(d=this.config.footer)||void 0===d?void 0:d.signatures)||void 0===h?void 0:h.length){var y=[];this.config.footer.signatures.forEach((function(t){y.push(t.label||"");var e=t.metadataPath?f._getValueByPath(t.metadataPath):t.name||"";y.push(e)})),m.push(y)}(null===(u=this.config.footer)||void 0===u?void 0:u.notes)&&m.push([this.config.footer.notes])}return m},t.prototype._emitEvent=function(t,e){this.eventListeners.has(t)&&this.eventListeners.get(t).forEach((function(o){try{o(e)}catch(e){console.error("事件".concat(t,"处理错误:"),e)}}))},t.globalFormatters={date:function(t){return new Date(t).toLocaleDateString()},currency:function(t,e){var o=e||{},n=o.currency,r=void 0===n?"CNY":n,a=o.locale,i=void 0===a?"zh-CN":a;return new Intl.NumberFormat(i,{style:"currency",currency:r}).format(t)},number:function(t,e){var o=e||{},n=o.precision,r=void 0===n?2:n,a=o.thousandSeparator,i={minimumFractionDigits:r,maximumFractionDigits:r,useGrouping:void 0===a||a};return new Intl.NumberFormat(void 0,i).format(t)},percentage:function(t,e){var o=(e||{}).precision,n=void 0===o?2:o;return new Intl.NumberFormat(void 0,{style:"percent",minimumFractionDigits:n,maximumFractionDigits:n}).format(t)}},t}();function u(t,e){var o={header:{font:{bold:!0,sz:12,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:"4472C4"}},alignment:{horizontal:"center",vertical:"center",wrapText:!0},border:{top:{style:"medium",color:{rgb:"366092"}},right:{style:"thin",color:{rgb:"366092"}},bottom:{style:"medium",color:{rgb:"366092"}},left:{style:"thin",color:{rgb:"366092"}}}},title:{font:{bold:!0,sz:18,color:{rgb:"000000"}},alignment:{horizontal:"center",vertical:"center"},border:{top:{style:"thin",color:{rgb:"CCCCCC"}},bottom:{style:"thin",color:{rgb:"CCCCCC"}}}},metadata:{font:{sz:11,color:{rgb:"333333"}},alignment:{horizontal:"left",vertical:"center"},border:{top:{style:"thin",color:{rgb:"EEEEEE"}},right:{style:"thin",color:{rgb:"EEEEEE"}},bottom:{style:"thin",color:{rgb:"EEEEEE"}},left:{style:"thin",color:{rgb:"EEEEEE"}}}},cell:{font:{sz:11,color:{rgb:"333333"}},alignment:{vertical:"center",wrapText:!0},border:{top:{style:"thin",color:{rgb:"DDDDDD"}},right:{style:"thin",color:{rgb:"DDDDDD"}},bottom:{style:"thin",color:{rgb:"DDDDDD"}},left:{style:"thin",color:{rgb:"DDDDDD"}}}},oddRow:{fill:{fgColor:{rgb:"E9EDF4"}}},evenRow:{fill:{fgColor:{rgb:"FFFFFF"}}},summary:{font:{bold:!0,sz:11,color:{rgb:"000000"}},alignment:{horizontal:"right",vertical:"center"},border:{top:{style:"medium",color:{rgb:"CCCCCC"}},bottom:{style:"medium",color:{rgb:"CCCCCC"}}}}};if(!e||0===e.length)return t;var n=function(t){if(t.length<3)return 0;for(var e=0;e<Math.min(10,t.length-1);e++)if(t[e]&&t[e+1]&&t[e].length===t[e+1].length&&t[e].length>=3)return e;return 0}(e),r=function(t,e){var o={titleRowIndex:-1,dataEndRowIndex:t.length-1,summaryRowIndices:[]};e>0&&(o.titleRowIndex=0);for(var n=t.length-1;n>e;n--){var r=t[n];if(r&&0!==r.length){for(var a=!1,i=0;i<r.length;i++){var l=r[i];if(l&&"string"==typeof l&&(l.includes("合计")||l.includes("总计")||l.includes("汇总")||l.includes("小计"))){a=!0,o.summaryRowIndices.push(n);break}}a||o.dataEndRowIndex!==t.length-1||(o.dataEndRowIndex=n)}}return o}(e,n);if(r.titleRowIndex>=0)for(var i=0;i<=r.titleRowIndex;i++)for(var c=0;c<(e[i]?e[i].length:0);c++){t[p=a.utils.encode_cell({r:i,c:c})]&&(t[p].s=0===i&&0===c?o.title:o.metadata)}if(n>=0)for(c=0;c<e[n].length;c++){t[p=a.utils.encode_cell({r:n,c:c})]&&(t[p].s=o.header)}for(i=n+1;i<=r.dataEndRowIndex;i++){var s=(i-n)%2==1;for(c=0;c<(e[i]?e[i].length:0);c++){if(t[p=a.utils.encode_cell({r:i,c:c})]){var d=f(e[i][c]);t[p].s=l(l(l({},o.cell),s?o.oddRow:o.evenRow),{alignment:l(l({},o.cell.alignment),{horizontal:d?"right":"left"})})}}}if(r.summaryRowIndices.length>0)for(var h=0,u=r.summaryRowIndices;h<u.length;h++)for(i=u[h],c=0;c<(e[i]?e[i].length:0);c++){var p;t[p=a.utils.encode_cell({r:i,c:c})]&&(t[p].s=o.summary)}return t}function f(t){if(null==t)return!1;if("number"==typeof t)return!0;if("string"==typeof t){var e=t.trim();return""!==e&&(!isNaN(Number(e))&&!isNaN(parseFloat(e))&&!e.includes(" "))}return!1}try{d=require("xlsx-js-style"),console.log("使用支持样式的XLSX库")}catch(t){d=a,console.log("使用标准XLSX库（样式支持有限）")}"undefined"!=typeof window&&setTimeout((function(){try{console.log("jsPDF库已内置到组件中"),function(){try{console.log("PDF导出修复已应用 (使用内置jsPDF)"),console.log("PDF导出修复已成功应用")}catch(t){console.warn("应用PDF修复时发生错误:",t)}}()}catch(t){console.warn("应用PDF导出修复失败:",t)}}),0);var p=function(){function t(){}return t.toExcel=function(t,e){return void 0===e&&(e={}),c(this,void 0,void 0,(function(){var o,n,r,a,i,l,c,h,u,f,p,m,g,v,y,b,w,C,x,E,S,_;return s(this,(function(s){try{if(o=e.fileName,n=void 0===o?"报表":o,r=e.sheetName,a=void 0===r?"Sheet1":r,i=e.includeHidden,l=e.styles,c=void 0,h=null,t instanceof HTMLElement?(h=t,c=this.extractDataFromDOM(t)):c=t,u=d.utils.aoa_to_sheet(c),f=[],c.length>0){for(p=function(t){var e=10;c.forEach((function(o){o[t]&&String(o[t]).length>e&&(e=Math.min(50,String(o[t]).length))})),f.push({wch:e})},m=0;m<c[0].length;m++)p(m);u["!cols"]=f}console.log("Excel导出数据结构:",{dataRows:c.length,hasDOMElement:!!h,firstRow:c[0],lastRow:c[c.length-1]}),console.log("使用增强样式应用到Excel");try{this.applyEnhancedStylesToExcel(u,c),console.log("增强样式应用成功")}catch(t){console.warn("增强样式应用失败，回退到基础样式:",t),this.applyBasicStylesToExcel(u,c)}["A1","A2","B1","B2"].forEach((function(t){u[t]&&console.log("单元格 ".concat(t," 样式:"),u[t].s)})),g=d.utils.book_new(),d.utils.book_append_sheet(g,u,a),g.Workbook||(g.Workbook={}),g.Workbook.Views||(g.Workbook.Views=[]),g.Workbook.Views[0]={RTL:!1};try{for(v=!1,y=0,b=["A1","A2","B1"];y<b.length;y++)if(u[w=b[y]]&&u[w].s){v=!0;break}console.log("Excel导出信息: 工作表包含".concat(Object.keys(u).length,"个单元格, 样式信息: ").concat(v?"有":"无")),g.Props={Title:n,Subject:"报表数据",Author:"DDR报表组件",CreatedDate:new Date};try{C={bookType:"xlsx",type:"buffer",cellStyles:!0,sheetStubs:!1,compression:!0},x=d.write(g,C),E=new Blob([x],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),S=window.URL.createObjectURL(E),(_=document.createElement("a")).href=S,_.download="".concat(n,".xlsx"),document.body.appendChild(_),_.click(),document.body.removeChild(_),window.URL.revokeObjectURL(S),console.log("Excel导出完成（Blob方式，支持样式）")}catch(t){console.warn("Blob导出失败，尝试直接导出:",t),d.writeFile(g,"".concat(n,".xlsx"),{cellStyles:!0,compression:!0}),console.log("Excel导出完成（直接导出方式）")}}catch(t){console.error("Excel导出失败:",t);try{d.writeFile(g,"".concat(n,".xlsx")),console.log("Excel导出完成（基础模式）")}catch(t){throw console.error("Excel基础导出也失败:",t),t}}return[2,Promise.resolve()]}catch(t){return[2,Promise.reject(t)]}return[2]}))}))},t.extractDataFromDOM=function(t){var e,o=[],n=t.querySelector(".ddr-report-header .ddr-header-title");n&&(o.push([(null===(e=n.textContent)||void 0===e?void 0:e.trim())||""]),o.push([]));var r=t.querySelectorAll(".ddr-header-fields .ddr-header-field");if(r.length>0){var a=[];r.forEach((function(t){var e,o,n,r,i=(null===(o=null===(e=t.querySelector(".ddr-field-label"))||void 0===e?void 0:e.textContent)||void 0===o?void 0:o.trim())||"",l=(null===(r=null===(n=t.querySelector(".ddr-field-value"))||void 0===n?void 0:n.textContent)||void 0===r?void 0:r.trim())||"";i&&l&&a.push("".concat(i," ").concat(l))})),a.length>0&&(o.push(a),o.push([]))}var i=t.querySelector("table");i&&i.querySelectorAll("tr").forEach((function(t){var e=t.querySelectorAll("td, th"),n=[];e.forEach((function(t){var e;n.push((null===(e=t.textContent)||void 0===e?void 0:e.trim())||"")})),n.length>0&&o.push(n)}));var l=t.querySelector(".ddr-report-footer");if(l){o.push([]);var c=l.querySelectorAll(".ddr-footer-summary .ddr-summary-item");if(c.length>0){var s=[];c.forEach((function(t){var e,o,n,r,a=(null===(o=null===(e=t.querySelector(".ddr-summary-label"))||void 0===e?void 0:e.textContent)||void 0===o?void 0:o.trim())||"",i=(null===(r=null===(n=t.querySelector(".ddr-summary-value"))||void 0===n?void 0:n.textContent)||void 0===r?void 0:r.trim())||"";a&&i&&s.push("".concat(a," ").concat(i))})),s.length>0&&o.push(s)}var d=l.querySelectorAll(".ddr-footer-fields .ddr-footer-field");if(d.length>0){var h=[];d.forEach((function(t){var e,o,n,r,a=(null===(o=null===(e=t.querySelector(".ddr-field-label"))||void 0===e?void 0:e.textContent)||void 0===o?void 0:o.trim())||"",i=(null===(r=null===(n=t.querySelector(".ddr-field-value"))||void 0===n?void 0:n.textContent)||void 0===r?void 0:r.trim())||"";a&&i&&h.push("".concat(a," ").concat(i))})),h.length>0&&o.push(h)}}return o},t.applyDOMStylesToExcel=function(t,e,o){console.log("开始应用DOM样式到Excel");try{var n=o.querySelector("table");if(!n)return console.log("未找到表格，使用默认样式"),void u(t,e);var r=!!o.querySelector(".ddr-report-header .ddr-header-title"),i=o.querySelectorAll(".ddr-header-fields .ddr-header-field").length>0;console.log("DOM结构分析:",{hasTitle:r,hasMetadata:i});var l=0,c={font:{bold:!0,sz:12,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:"4472C4"}},alignment:{horizontal:"center",vertical:"center"}},s={font:{sz:11},alignment:{vertical:"center"}};if(r){var h=a.utils.encode_cell({r:l,c:0});t[h]&&(t[h].s={font:{bold:!0,sz:16},alignment:{horizontal:"center",vertical:"center"}},console.log("应用标题样式到 ".concat(h))),l+=2}i&&(l+=2);var f=n.querySelectorAll("tr"),p=!0;f.forEach((function(e,o){var n=e.querySelectorAll("td, th"),r=null!==e.querySelector("th")||p;n.forEach((function(e,n){var a=l+o,i=d.utils.encode_cell({r:a,c:n});t[i]&&(r?(t[i].s=c,console.log("应用表头样式到 ".concat(i))):t[i].s=s)})),p&&r&&(p=!1)})),console.log("DOM样式应用完成")}catch(o){console.error("应用DOM样式失败:",o),u(t,e)}},t.applyBasicStylesToExcel=function(t,e){console.log("开始应用基础样式到Excel");try{for(var o=d.utils.decode_range(t["!ref"]||"A1"),n=o.s.c;n<=o.e.c;n++){t[a=d.utils.encode_cell({r:0,c:n})]&&(t[a].s={font:{bold:!0,sz:12},fill:{fgColor:{rgb:"DDDDDD"}},alignment:{horizontal:"center",vertical:"center"}},console.log("应用表头样式到 ".concat(a)))}for(var r=1;r<=o.e.r;r++)for(n=o.s.c;n<=o.e.c;n++){var a;t[a=d.utils.encode_cell({r:r,c:n})]&&(t[a].s={font:{sz:10},alignment:{vertical:"center"}})}console.log("基础样式应用完成")}catch(t){console.error("应用基础样式失败:",t)}},t.applyEnhancedStylesToExcel=function(t,e){console.log("开始应用增强样式到Excel");try{for(var o=d.utils.decode_range(t["!ref"]||"A1"),n={font:{bold:!0,sz:12,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:"4472C4"}},alignment:{horizontal:"center",vertical:"center"},border:{top:{style:"thin",color:{rgb:"000000"}},bottom:{style:"thin",color:{rgb:"000000"}},left:{style:"thin",color:{rgb:"000000"}},right:{style:"thin",color:{rgb:"000000"}}}},r={font:{sz:10},alignment:{vertical:"center"},border:{top:{style:"thin",color:{rgb:"CCCCCC"}},bottom:{style:"thin",color:{rgb:"CCCCCC"}},left:{style:"thin",color:{rgb:"CCCCCC"}},right:{style:"thin",color:{rgb:"CCCCCC"}}}},a={font:{sz:10},fill:{fgColor:{rgb:"F8F9FA"}},alignment:{vertical:"center"},border:{top:{style:"thin",color:{rgb:"CCCCCC"}},bottom:{style:"thin",color:{rgb:"CCCCCC"}},left:{style:"thin",color:{rgb:"CCCCCC"}},right:{style:"thin",color:{rgb:"CCCCCC"}}}},i=o.s.c;i<=o.e.c;i++){t[s=d.utils.encode_cell({r:0,c:i})]&&(t[s].s=n,console.log("应用增强表头样式到 ".concat(s)))}for(var l=1;l<=o.e.r;l++){var c=l%2==0?a:r;for(i=o.s.c;i<=o.e.c;i++){var s;t[s=d.utils.encode_cell({r:l,c:i})]&&(t[s].s=c)}}t["!cols"]||(t["!cols"]=[]);for(i=o.s.c;i<=o.e.c;i++)t["!cols"][i]={wch:15};console.log("增强样式应用完成")}catch(o){console.error("应用增强样式失败，回退到基础样式:",o),this.applyBasicStylesToExcel(t,e)}},t.rgbToHex=function(t){if(!t||"transparent"===t)return"FFFFFF";var e=t.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);return e?(parseInt(e[1])<<16|parseInt(e[2])<<8|parseInt(e[3])).toString(16).padStart(6,"0").toUpperCase():"FFFFFF"},t.getExcelAlignment=function(t){switch(t){case"center":return"center";case"right":return"right";case"justify":return"justify";default:return"left"}},t.toPDF=function(t,e,n){var r,a,d,h,u,f,p,m;return void 0===n&&(n={}),c(this,void 0,void 0,(function(){var c,g,v,y,b,w,C,x,E,S,_,P,M,F,k,D,N,T,O,R,A,z,j,q,L,I,B,H,G,W,V,U,J,Y,K,X,$,Q,Z,tt,et,ot,nt,rt,at,it,lt,ct,st,dt,ht,ut,ft,pt,mt,gt,vt,yt,bt,wt,Ct,xt,Et,St,_t,Pt,Mt,Ft,kt,Dt,Nt,Tt,Ot,Rt,At,zt,jt,qt,Lt,It,Bt,Ht,Gt,Wt,Vt,Ut,Jt,Yt,Kt,Xt,$t,Qt,Zt,te,ee,oe,ne,re,ae,ie,le,ce,se,de,he,ue,fe,pe,me,ge,ve,ye,be,we,Ce,xe,Ee,Se,_e,Pe,Me,Fe,ke,De,Ne,Te,Oe,Re,Ae,ze;return s(this,(function(s){switch(s.label){case 0:if(s.trys.push([0,14,,15]),console.log("PDF导出开始，使用内置jsPDF库"),c=n.fileName,g=void 0===c?"报表":c,v=n.watermark,y=n.pdf,b=void 0===y?{}:y,w=(null===(r=null==e?void 0:e.features)||void 0===r?void 0:r.pdfConfig)||{},C=l(l({},w),b),x=void 0!==v?v:(null===(a=null==e?void 0:e.features)||void 0===a?void 0:a.watermark)||"",console.log("PDF导出配置:",{configPdfSettings:w,pdfOptions:b,mergedPdfOptions:C}),console.log("水印处理:",{"方法参数watermark":v,"配置中的watermark":null===(d=null==e?void 0:e.features)||void 0===d?void 0:d.watermark,"最终使用的watermark":x}),E=C.pageSize||"A4",S=C.orientation||"portrait",_=C.quality||.95,P=!1!==C.multiPage,M=!1!==C.relayout,console.log("PDF设置 - 页面大小: ".concat(E,", 方向: ").concat(S,", 重新排版: ").concat(M)),F={top:(null===(h=C.margins)||void 0===h?void 0:h.top)||15,right:(null===(u=C.margins)||void 0===u?void 0:u.right)||15,bottom:(null===(f=C.margins)||void 0===f?void 0:f.bottom)||15,left:(null===(p=C.margins)||void 0===p?void 0:p.left)||15},k=t.scrollTop,(D=t.cloneNode(!0)).style.position="absolute",D.style.left="-9999px",D.style.overflow="visible",D.style.height="auto",M?(N=("landscape"===S?"A4"===E?297:279:"A4"===E?210:216)-F.left-F.right,T="landscape"===S?4:3.78,O=Math.floor(N*T),D.style.width=O+"px",D.style.maxWidth=O+"px",D.querySelectorAll("table").forEach((function(t){var e=t;(e.style.width="100%",e.style.tableLayout="fixed","landscape"===S)&&e.querySelectorAll("td, th").forEach((function(t){t.style.padding="3px 4px"}))}))):(D.style.width=t.clientWidth+"px",console.log("使用缩放模式，保持原始宽度:",t.clientWidth+"px")),document.body.appendChild(D),R=D.querySelector(".ddr-report-header"),A=D.querySelector(".ddr-report-footer"),(z=D.querySelector(".ddr-table-container"))||console.warn("未找到表格容器元素，导出可能不完整"),z&&(z.style.maxHeight="none",z.style.height="auto",z.style.overflow="visible",(X=z.querySelector("table"))&&(X.style.width="100%",X.querySelectorAll("td, th").forEach((function(t){t.style.border="1px solid #ddd"})))),R&&(R.style.position="relative",R.style.height="auto",R.style.overflow="visible"),A&&(A.style.position="relative",A.style.height="auto",A.style.overflow="visible"),function(t){try{t.setFont("helvetica");var e=t.text;return t.text=function(t,o,n,r){try{return e.call(this,function(t){try{return t.replace(/：/g,":").replace(/，/g,",").replace(/。/g,".").replace(/（/g,"(").replace(/）/g,")").replace(/；/g,";")}catch(e){return t}}(t),o,n,r)}catch(i){console.warn("文字渲染失败:",i);var a=t.replace(/[^\x00-\x7F]/g,"?");return e.call(this,a,o,n,r)}},t}catch(e){return console.warn("中文支持设置失败:",e),t}}(j=new o.jsPDF({orientation:S,unit:"mm",format:E})),q=j.internal.pageSize.getWidth(),L=j.internal.pageSize.getHeight(),I=L-F.top-F.bottom,B=q-F.left-F.right,j.setFontSize(12),!P)return[3,13];if(H=0,G=void 0,!R)return[3,4];s.label=1;case 1:return s.trys.push([1,3,,4]),W=R.getBoundingClientRect(),console.log("📏 报表头DOM尺寸：".concat(Math.round(W.width),"px × ").concat(Math.round(W.height),"px")),[4,i.default(R,{scale:2,useCORS:!0,logging:!1,allowTaint:!0,backgroundColor:"#FFFFFF"})];case 2:return G=s.sent(),H=G.height/G.width*B,console.log("📏 报表头Canvas尺寸：".concat(G.width,"px × ").concat(G.height,"px")),console.log("📏 报表头实际高度：".concat(Math.round(100*H)/100,"mm")),[3,4];case 3:return V=s.sent(),console.warn("渲染表头时出错:",V),[3,4];case 4:if(U=0,J=void 0,!A)return[3,8];s.label=5;case 5:return s.trys.push([5,7,,8]),Y=A.getBoundingClientRect(),console.log("📏 报表尾DOM尺寸：".concat(Math.round(Y.width),"px × ").concat(Math.round(Y.height),"px")),[4,i.default(A,{scale:2,useCORS:!0,logging:!1,allowTaint:!0,backgroundColor:"#FFFFFF"})];case 6:return J=s.sent(),U=J.height/J.width*B,console.log("📏 报表尾Canvas尺寸：".concat(J.width,"px × ").concat(J.height,"px")),console.log("📏 报表尾实际高度：".concat(Math.round(100*U)/100,"mm")),[3,8];case 7:return K=s.sent(),console.warn("渲染表尾时出错:",K),[3,8];case 8:if(!(X=(null==z?void 0:z.querySelector("table"))||z))throw new Error("找不到表格元素");$=X.getBoundingClientRect(),console.log("📏 表格DOM尺寸：".concat(Math.round($.width),"px × ").concat(Math.round($.height),"px")),Q=void 0,Z=void 0,tt=void 0,s.label=9;case 9:return s.trys.push([9,11,,13]),[4,i.default(X,{scale:2,useCORS:!0,logging:!1,allowTaint:!0,backgroundColor:"#FFFFFF"})];case 10:for(Q=s.sent(),Z=B,tt=Q.height/Q.width*Z,console.log("📏 表格Canvas尺寸：".concat(Q.width,"px × ").concat(Q.height,"px")),console.log("📏 表格实际高度：".concat(Math.round(100*tt)/100,"mm")),et=X.querySelectorAll("tr"),ot=et.length,nt=0,rt=0;rt<et.length&&et[rt].querySelector("th");rt++)nt++;for(at=ot-nt,console.log("📊 表格行数统计：总行数=".concat(ot,", 表头行数=").concat(nt,", 数据行数=").concat(at)),console.log("🔍 开始重构PDF分页算法..."),it=0,lt=0,G&&(it=H,console.log("📏 报表头实际高度：".concat(Math.round(it),"mm"))),J&&(lt=U,console.log("📏 报表尾实际高度：".concat(Math.round(lt),"mm"))),void 0,st=Q.height/ot,ct=st/Q.height*tt,console.log("📏 Canvas行高计算：总高度".concat(Q.height,"px ÷ ").concat(ot,"行 = ").concat(Math.round(100*st)/100,"px/行")),console.log("📏 PDF行高：".concat(Math.round(100*ct)/100,"mm/行")),(null===(m=null==e?void 0:e.layout)||void 0===m?void 0:m.rowHeight)&&(dt="number"==typeof e.layout.rowHeight?e.layout.rowHeight:parseInt(e.layout.rowHeight),ht=25.4*dt/96,console.log("📏 配置行高：".concat(dt,"px → ").concat(Math.round(100*ht)/100,"mm")),console.log("📏 Canvas行高：".concat(Math.round(100*ct)/100,"mm")),console.log("📏 使用Canvas行高以确保数据完整性")),console.log("📐 页面布局参数："),console.log("- 页面总高度：".concat(Math.round(L),"mm")),console.log("- 上下边距：".concat(F.top+F.bottom,"mm")),console.log("- 页码预留：".concat(15,"mm")),console.log("- 安全边距：".concat(3,"mm")),ut=L-F.top-F.bottom-15-3,ft=ut-it-0,pt=ut,mt=ut-lt-0,console.log("📐 各页可用数据高度："),console.log("- 第一页数据区：".concat(Math.round(ft),"mm")),console.log("- 中间页数据区：".concat(Math.round(pt),"mm")),console.log("- 最后页数据区：".concat(Math.round(mt),"mm")),gt=Math.floor(ft/ct),vt=Math.floor(pt/ct),yt=Math.floor(mt/ct),console.log("📊 保守计算的各页最大行数："),console.log("- 第一页：".concat(gt,"行 (").concat(Math.round(ft),"mm ÷ ").concat(Math.round(100*ct)/100,"mm)")),console.log("- 中间页：".concat(vt,"行 (").concat(Math.round(pt),"mm ÷ ").concat(Math.round(100*ct)/100,"mm)")),console.log("- 最后页：".concat(yt,"行 (").concat(Math.round(mt),"mm ÷ ").concat(Math.round(100*ct)/100,"mm)")),console.log("🔍 空间利用率验证："),console.log("- 第一页：".concat(gt,"行 × ").concat(Math.round(100*ct)/100,"mm = ").concat(Math.round(gt*ct),"mm，可用").concat(Math.round(ft),"mm，利用率").concat(Math.round(gt*ct/ft*100),"%")),console.log("- 中间页：".concat(vt,"行 × ").concat(Math.round(100*ct)/100,"mm = ").concat(Math.round(vt*ct),"mm，可用").concat(Math.round(pt),"mm，利用率").concat(Math.round(vt*ct/pt*100),"%")),bt=[],wt=0,Ct=0,console.log("🔄 开始智能分页算法，总数据行数：".concat(at));wt<at;)xt=void 0,0===Ct?(xt=gt,console.log("📄 第".concat(Ct+1,"页（首页）：最大可容纳").concat(xt,"行"))):(Et=at-wt)<=yt?(xt=Et,console.log("📄 第".concat(Ct+1,"页（末页）：显示剩余").concat(Et,"行"))):(xt=vt,console.log("📄 第".concat(Ct+1,"页（中间页）：最大可容纳").concat(xt,"行"))),Jt=Math.min(xt,at-wt),wt+=Jt,console.log("📊 第".concat(Ct+1,"页实际显示：").concat(Jt,"行，累计处理：").concat(wt,"/").concat(at,"行")),wt<at&&(_t=(St=it/tt)+wt/at*(1-St-lt/tt),bt.push({yPercent:_t,endRow:wt}),console.log("📍 创建分页点".concat(Ct+1,"：第").concat(wt,"行结束，Y=").concat(Math.round(100*_t),"%"))),Ct++;for(console.log("✅ 分页算法完成：共".concat(Ct,"页，处理").concat(wt,"行数据，创建").concat(bt.length,"个分页点")),Pt=bt.length+1,console.log("📊 总计需要 ".concat(Pt," 页显示 ").concat(at," 行数据")),Mt=G?G.toDataURL("image/jpeg",_):null,(Ft=J?J.toDataURL("image/jpeg",_):null)&&(kt=bt.length>0?at-bt[bt.length-1].endRow:at,Nt=mt-(Dt=kt*ct),console.log("📋 报表尾检查："),console.log("- 最后一页数据行数：".concat(kt)),console.log("- 最后一页数据占用高度：".concat(Math.round(Dt),"mm")),console.log("- 最后一页剩余高度：".concat(Math.round(Nt),"mm")),console.log("- 报表尾需要高度：".concat(Math.round(lt+0),"mm")),Nt<lt+0?console.log("⚠️ 最后一页空间不足，报表尾将在新页显示"):console.log("✅ 最后一页空间充足，报表尾将在当前页显示")),Tt=0;Tt<Pt;Tt++){if(Tt>0&&j.addPage(),Ot=F.top,Mt&&0===Tt&&(j.addImage(Mt,"JPEG",F.left,Ot,B,H),Ot+=H),(Rt=!1!==C.repeatTableHeader)&&Tt>0&&nt>0)try{console.log("📄 第".concat(Tt+1,"页添加表格标题行")),(At=document.createElement("canvas")).width=Q.width,zt=nt/ot*Q.height,At.height=Math.ceil(zt),(jt=At.getContext("2d"))&&(jt.fillStyle="#ffffff",jt.fillRect(0,0,At.width,At.height),jt.drawImage(Q,0,0,Q.width,zt,0,0,At.width,At.height),qt=At.height/Q.height*tt,Lt=At.toDataURL("image/jpeg",_),j.addImage(Lt,"JPEG",F.left,Ot,B,qt),Ot+=qt,console.log("📄 第".concat(Tt+1,"页表格标题行添加完成，高度：").concat(Math.round(qt),"mm")))}catch(t){console.warn("第".concat(Tt+1,"页添加表格标题行失败:"),t)}It=0,Bt=1,bt.length>0?0===Tt?(It=0,Bt=bt[0].yPercent,Ut=bt[0].endRow,console.log("📄 第1页：显示表头+第1-".concat(Ut,"行，Y范围：0% 到 ").concat(Math.round(100*bt[0].yPercent),"%"))):(It=bt[Tt-1].yPercent,Bt=Tt<bt.length?bt[Tt].yPercent:1,Vt=bt[Tt-1].endRow+1,Ut=Tt<bt.length?bt[Tt].endRow:at,console.log("📄 第".concat(Tt+1,"页：显示第").concat(Vt,"-").concat(Ut,"行，Y范围：").concat(Math.round(100*It),"% 到 ").concat(Math.round(100*Bt),"%"))):console.log("📄 第".concat(Tt+1,"页：显示所有内容（单页模式）")),Ht=void 0,Gt=void 0,Wt=void 0,bt.length>0?0===Tt?(Ut=bt[0].endRow,Ht=0,Yt=nt/ot*Q.height,Kt=Q.height/ot,$t=Yt+Ut*Kt,Gt=Math.floor($t),Wt=Gt/Q.height*tt,console.log("📐 第1页行边界裁剪：表头".concat(nt,"行+数据").concat(Ut,"行，Canvas高度=").concat(Math.round(Gt),"px，PDF高度=").concat(Math.round(Wt),"mm"))):(Vt=bt[Tt-1].endRow,Ut=Tt<bt.length?bt[Tt].endRow:at,Jt=Ut-Vt,console.log("📐 第".concat(Tt+1,"页数据行：第").concat(Vt+1,"-").concat(Ut,"行（").concat(Jt,"行）")),Yt=nt/ot*Q.height,Kt=Q.height/ot,Xt=Yt+Vt*Kt,$t=Yt+Ut*Kt,Ht=0===Vt?Math.floor(Yt-1):Math.floor(Xt),Qt=Math.floor($t),Gt=Math.min(Qt-Ht,Q.height-Ht),Wt=Gt/Q.height*tt,console.log("📐 第".concat(Tt+1,"页数据行裁剪：第").concat(Vt+1,"-").concat(Ut,"行，Canvas范围=").concat(Math.round(Ht),"-").concat(Math.round(Ht+Gt),"px，PDF高度=").concat(Math.round(Wt),"mm"))):(Ht=Math.floor(It*Q.height),Gt=Math.ceil((Bt-It)*Q.height),Wt=Gt/Q.height*tt,console.log("📐 单页模式：源高度=".concat(Math.round(Gt),"px，目标高度=").concat(Math.round(Wt),"mm"))),Zt=L-Ot-F.bottom-15,Wt>Zt&&(console.warn("⚠️ 第".concat(Tt+1,"页内容高度").concat(Math.round(Wt),"mm超出可用空间").concat(Math.round(Zt),"mm")),(te=Wt-Zt)<=8&&console.log("📐 动态调整：压缩页码预留空间".concat(Math.round(te),"mm")));try{(ee=document.createElement("canvas")).width=Q.width,ee.height=Gt,(oe=ee.getContext("2d"))&&(oe.fillStyle="#ffffff",oe.fillRect(0,0,ee.width,ee.height),oe.drawImage(Q,0,Ht,Q.width,Gt,0,0,ee.width,ee.height),Tt>0&&(!Rt||0===nt)&&(oe.strokeStyle="#ddd",oe.lineWidth=1,oe.beginPath(),oe.moveTo(0,.5),oe.lineTo(ee.width,.5),oe.stroke(),console.log("📄 第".concat(Tt+1,"页添加顶部边框线（无表头模式）"))),ne=ee.toDataURL("image/jpeg",_),j.addImage(ne,"JPEG",F.left,Ot,B,Wt),Ot+=Wt)}catch(t){console.warn("处理表格页码时出错:",t)}if(Pt>1)try{j.setFontSize(10),j.setTextColor(80,80,80),ae=(re=Ot)+5,ie=L-F.bottom+3,he=Math.min(ie,Math.max(ae,L-8)),j.text("Page ".concat(Tt+1," / ").concat(Pt),q/2,he,{align:"center"}),console.log("第".concat(Tt+1,"页添加页码，内容底部：").concat(Math.round(re),"mm，页码位置：Y=").concat(Math.round(he),"mm"))}catch(t){console.warn("页码渲染失败:",t)}if(Ft&&Tt===Pt-1)if(le=Ot,ce=L-F.bottom-15-U,(se=Math.max(le,ce))+U>L-F.bottom-15){if(console.log("📄 表尾需要新页显示，当前页剩余空间不足"),j.addPage(),j.addImage(Ft,"JPEG",F.left,F.top,B,U),Pt>1&&(de=Pt+1,j.setFontSize(10),j.setTextColor(80,80,80),he=L-F.bottom+3,j.text("Page ".concat(de," / ").concat(de),q/2,he,{align:"center"})),x)try{(ue=document.createElement("canvas")).width=400,ue.height=100,(fe=ue.getContext("2d"))&&(fe.font="40px Arial, sans-serif",fe.fillStyle="rgba(200, 200, 200, 0.3)",fe.textAlign="center",fe.textBaseline="middle",fe.translate(200,50),fe.rotate(45*Math.PI/180),fe.fillText(x,0,0),Pe=ue.toDataURL("image/png"),j.addImage(Pe,"PNG",q/2-50,L/2-12.5,100,25,void 0,"NONE"))}catch(t){console.warn("新页水印添加失败:",t)}}else console.log("📄 在第".concat(Tt+1,"页添加表尾，位置：Y=").concat(Math.round(se),"mm")),j.addImage(Ft,"JPEG",F.left,se,B,U);if(x)try{if(console.log("第".concat(Tt+1,'页开始添加全页面水印: "').concat(x,'"')),ue=document.createElement("canvas"),ue.width=2*q*4,ue.height=2*L*4,!(fe=ue.getContext("2d")))throw new Error("无法创建canvas上下文");for(fe.clearRect(0,0,ue.width,ue.height),pe=x.length,me=Math.max(24,Math.min(48,600/pe)),fe.font="".concat(me,"px Arial, sans-serif"),fe.fillStyle="rgba(180, 180, 180, 0.15)",fe.textAlign="center",fe.textBaseline="middle",ge=fe.measureText(x),ve=ge.width,ye=1.8*ve,be=4.5*me,we=Math.ceil(ue.width/ye)+2,Ce=Math.ceil(ue.height/be)+2,console.log("水印参数: 字体".concat(me,"px, 文字宽度").concat(Math.round(ve),"px, 间距").concat(Math.round(ye),"x").concat(Math.round(be),"px, 网格").concat(we,"x").concat(Ce)),xe=0;xe<Ce;xe++)for(Ee=0;Ee<we;Ee++)fe.save(),Se=Ee*ye-ye/2,_e=xe*be-be/2,fe.translate(Se,_e),fe.rotate(45*Math.PI/180),fe.fillText(x,0,0),fe.restore();Pe=ue.toDataURL("image/png"),j.addImage(Pe,"PNG",0,0,q,L,void 0,"NONE"),console.log("第".concat(Tt+1,"页成功添加全页面平铺水印"))}catch(t){console.warn("第".concat(Tt+1,"页添加水印失败，尝试简化水印:"),t);try{j.setTextColor(200,200,200),j.setFontSize(30),Me=q/2,Fe=L/2,j.text(x,Me,Fe,{align:"center",baseline:"middle",angle:45}),console.log("第".concat(Tt+1,'页添加简化水印: "').concat(x,'"'))}catch(t){console.warn("第".concat(Tt+1,"页简化水印也失败:"),t)}}}return[3,13];case 11:return ke=s.sent(),console.warn("处理表格时出错:",ke),[4,i.default(D,{scale:1.5,useCORS:!0,logging:!1,allowTaint:!0,backgroundColor:"#FFFFFF"})];case 12:return De=s.sent(),Ne=De.toDataURL("image/jpeg",_),Te=De.width/De.height,Oe=B/I,Re=void 0,Ae=void 0,M?(Re=B,Ae=De.height/De.width*Re,console.log("重新排版模式 - 图像尺寸:",{imgWidth:Re,imgHeight:Ae})):(Te>Oe?Ae=(Re=B)/Te:Re=(Ae=I)*Te,console.log("缩放模式 - 等比例缩放图像尺寸:",{imgWidth:Re,imgHeight:Ae,canvasAspectRatio:Te,pageAspectRatio:Oe})),j.addImage(Ne,"JPEG",F.left,F.top,Re,Ae),[3,13];case 13:return document.body.removeChild(D),t.scrollTop=k,j.save("".concat(g,".pdf")),[2,Promise.resolve()];case 14:return ze=s.sent(),console.error("PDF导出失败:",ze),[2,Promise.reject(ze)];case 15:return[2]}}))}))},t.toPrint=function(t,e,o){var n,r;return void 0===o&&(o={}),c(this,void 0,void 0,(function(){var a,i,c,d,h,u,f,p,m,g,v,y;return s(this,(function(s){switch(s.label){case 0:return s.trys.push([0,3,,4]),console.log("开始打印，重用PDF绘制逻辑"),a=o.watermark,i=o.pdf,c=void 0===i?{}:i,d=(null===(n=null==e?void 0:e.features)||void 0===n?void 0:n.pdfConfig)||{},h=l(l({},d),c),u=void 0!==a?a:(null===(r=null==e?void 0:e.features)||void 0===r?void 0:r.watermark)||"",f=h.orientation||"portrait",p=h.pageSize||"A4",console.log("打印设置 - 页面大小: ".concat(p,", 方向: ").concat(f)),[4,this._createPrintContainer(t,e,h,u)];case 1:return m=s.sent(),g=this._createPrintStyle(f,p),document.head.appendChild(g),m.style.position="fixed",m.style.left="-9999px",m.style.top="0",m.style.zIndex="9999",document.body.appendChild(m),[4,new Promise((function(t){return setTimeout(t,100)}))];case 2:return s.sent(),m.style.left="0",m.style.position="absolute",(v=document.querySelectorAll("body > *:not(.ddr-print-container)")).forEach((function(t){t.style.display="none"})),window.print(),setTimeout((function(){v.forEach((function(t){t.style.display=""})),document.body.removeChild(m),document.head.removeChild(g),document.querySelectorAll('[data-ddr-print-watermark="true"]').forEach((function(t){return t.remove()}))}),100),console.log("打印完成"),[2,Promise.resolve()];case 3:return y=s.sent(),console.error("打印失败:",y),[2,Promise.reject(y)];case 4:return[2]}}))}))},t._createPrintContainer=function(t,e,o,n){return c(this,void 0,void 0,(function(){var r,a,i;return s(this,(function(l){switch(l.label){case 0:return(r=t.cloneNode(!0)).className="ddr-print-container",r.style.width="100%",r.style.height="auto",r.style.overflow="visible",r.style.backgroundColor="#ffffff",r.style.color="#000000",r.querySelectorAll(".ddr-watermark, .ddr-watermark-content").forEach((function(t){return t.remove()})),r.querySelectorAll(".ddr-report-header, .ddr-report-footer").forEach((function(t){var e=t;e.style.backgroundImage="none",e.style.background="none",e.querySelectorAll('[class*="watermark"]').forEach((function(t){return t.remove()}))})),[4,this._applyPrintTableLayout(r,e,o)];case 1:return l.sent(),(a=r.querySelector(".ddr-report-header"))&&(a.style.pageBreakInside="avoid",a.style.marginBottom="20px"),(i=r.querySelector(".ddr-report-footer"))&&(i.style.pageBreakInside="avoid",i.style.marginTop="20px"),n&&this._addPrintWatermark(r,n),[2,r]}}))}))},t._applyPrintTableLayout=function(t,e,o){return c(this,void 0,void 0,(function(){var n,r,a,i,l,c,d,h,u,f,p,m;return s(this,(function(s){return(n=t.querySelector(".ddr-table-container"))?(n.style.maxHeight="none",n.style.height="auto",n.style.overflow="visible",(r=n.querySelector("table"))?(a=o.orientation||"portrait",i=o.pageSize||"A4",console.log("🖨️ 应用打印表格布局：".concat(i," ").concat(a)),c=(l="landscape"===a?"A4"===i?297:279:"A4"===i?210:216)-30,d=Math.floor(3.78*c),console.log("🖨️ 打印页面宽度：".concat(l,"mm，内容宽度：").concat(c,"mm (").concat(d,"px)")),r.style.width="100%",r.style.maxWidth="".concat(d,"px"),r.style.tableLayout="fixed",r.style.borderCollapse="collapse",(null==e?void 0:e.columns)&&(h=this._getFlatColumns(e.columns),u=h.filter((function(t){return!1!==t.visible})),f=0,u.forEach((function(t){t.width&&(f+="number"==typeof t.width?t.width:parseInt(t.width))})),console.log("🖨️ 列配置总宽度：".concat(f,"px，目标宽度：").concat(d,"px")),p=r.querySelectorAll("col"),m=r.querySelectorAll("tr"),u.forEach((function(t,e){var o;if(t.width){var n="number"==typeof t.width?t.width:parseInt(t.width);o=Math.floor(n/f*d)}else o=Math.floor(d/u.length);console.log('🖨️ 列 "'.concat(t.key,'" 宽度：').concat(o,"px")),p[e]&&(p[e].style.width="".concat(o,"px")),m.forEach((function(t){var n=t.querySelectorAll("td, th");if(n[e]){var r=n[e];r.style.width="".concat(o,"px"),r.style.maxWidth="".concat(o,"px"),r.style.minWidth="".concat(o,"px"),r.style.boxSizing="border-box"}}))}))),r.querySelectorAll("td, th").forEach((function(t){var e=t;e.style.border="1px solid #ddd",e.style.padding="6px 8px",e.style.fontSize="11px",e.style.lineHeight="1.3",e.style.wordWrap="break-word",e.style.overflow="hidden"})),r.querySelectorAll("th").forEach((function(t){var e=t;e.style.backgroundColor="#f5f5f5",e.style.fontWeight="bold",e.style.fontSize="11px"})),[2]):[2]):[2]}))}))},t._getFlatColumns=function(t){var e=[],o=function(t){t.forEach((function(t){t.children&&t.children.length>0?o(t.children):e.push(t)}))};return o(t),e},t._createPrintStyle=function(t,e){var o=document.createElement("style");o.className="ddr-print-style";var n="landscape"===t?"landscape":"portrait",r=e.toLowerCase();return o.textContent="\n      @media print {\n        @page {\n          size: ".concat(r," ").concat(n,";\n          margin: 15mm;\n        }\n\n        body {\n          margin: 0;\n          padding: 0;\n          font-family: Arial, sans-serif;\n          font-size: 12px;\n          line-height: 1.4;\n          color: #000;\n          background: #fff;\n        }\n\n        .ddr-print-container {\n          width: 100% !important;\n          height: auto !important;\n          overflow: visible !important;\n          position: relative !important;\n          left: 0 !important;\n          top: 0 !important;\n          margin: 0 !important;\n          padding: 0 !important;\n          box-shadow: none !important;\n          border: none !important;\n        }\n\n        .ddr-table-container {\n          overflow: visible !important;\n          height: auto !important;\n          max-height: none !important;\n        }\n\n        .ddr-table {\n          width: 100% !important;\n          border-collapse: collapse !important;\n          page-break-inside: auto !important;\n        }\n\n        .ddr-table-row {\n          page-break-inside: avoid !important;\n          page-break-after: auto !important;\n        }\n\n        .ddr-header, .ddr-report-header {\n          page-break-inside: avoid !important;\n          page-break-after: avoid !important;\n        }\n\n        .ddr-footer, .ddr-report-footer {\n          page-break-inside: avoid !important;\n          page-break-before: avoid !important;\n        }\n\n        .ddr-print-watermark {\n          position: fixed !important;\n          top: 0 !important;\n          left: 0 !important;\n          width: 100vw !important;\n          height: 100vh !important;\n          pointer-events: none !important;\n          z-index: 999 !important;\n          opacity: 0.15 !important;\n          overflow: hidden !important;\n        }\n\n        .ddr-print-watermark-text {\n          position: absolute !important;\n          font-size: 24px !important;\n          font-weight: bold !important;\n          color: #ccc !important;\n          transform: rotate(-45deg) !important;\n          white-space: nowrap !important;\n          user-select: none !important;\n        }\n\n        /* 隐藏不需要打印的元素 */\n        .no-print {\n          display: none !important;\n        }\n      }\n    "),o},t._addPrintWatermark=function(t,e){console.log('🖨️ 添加统一的全页面打印水印: "'.concat(e,'"'));var o=document.createElement("div");o.className="ddr-print-watermark",o.style.position="fixed",o.style.top="0",o.style.left="0",o.style.width="100vw",o.style.height="100vh",o.style.pointerEvents="none",o.style.zIndex="999",o.style.overflow="hidden",o.style.opacity="0.15";for(var n=0;n<8;n++)for(var r=0;r<6;r++){var a=document.createElement("div");a.className="ddr-print-watermark-text",a.textContent=e,a.style.position="absolute",a.style.fontSize="24px",a.style.fontWeight="bold",a.style.color="#ccc",a.style.opacity="1",a.style.whiteSpace="nowrap",a.style.userSelect="none",a.style.pointerEvents="none";var i=(r+.5)*(100/6),l=12.5*(n+.5);a.style.left="".concat(i,"%"),a.style.top="".concat(l,"%"),a.style.transform="translate(-50%, -50%) rotate(-45deg)",a.style.transformOrigin="center",o.appendChild(a)}document.body.appendChild(o),o.setAttribute("data-ddr-print-watermark","true"),console.log("🖨️ 水印添加完成，共创建 ".concat(48," 个水印元素"))},t}(),m=Object.freeze({__proto__:null,Exporter:p});exports.DDR=h,exports.default=h;
//# sourceMappingURL=ddr-core.js.map
