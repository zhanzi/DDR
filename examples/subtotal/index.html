<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DDRæŠ¥è¡¨å°è®¡åˆè®¡ç¤ºä¾‹</title>
  <link rel="stylesheet" href="../../dist/ddr-core.css">
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB',
        'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    .container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .toolbar {
      padding: 16px;
      background-color: #f5f5f5;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .report-container {
      flex: 1;
      padding: 16px;
      overflow: auto;
    }

    .report {
      height: 100%;
      border: 1px solid #e0e0e0;
      overflow: auto;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    button {
      padding: 8px 16px;
      border: none;
      background-color: #1890ff;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #40a9ff;
    }

    .demo-button {
      background-color: #52c41a;
    }

    .demo-button:hover {
      background-color: #73d13d;
    }

    .info {
      background-color: #e6f7ff;
      border: 1px solid #91d5ff;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .info h3 {
      margin: 0 0 8px 0;
      color: #1890ff;
    }

    .info ul {
      margin: 8px 0 0 0;
      padding-left: 20px;
    }

    .info li {
      margin: 4px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="toolbar">
      <button id="demo1" class="demo-button">ç¤ºä¾‹1ï¼šæŒ‰åœ°åŒºåˆ†ç»„å°è®¡</button>
      <button id="demo2" class="demo-button">ç¤ºä¾‹2ï¼šå¤šçº§åˆ†ç»„å°è®¡</button>
      <button id="demo3" class="demo-button">ç¤ºä¾‹3ï¼šå¤æ‚æ±‡æ€»æŠ¥è¡¨</button>
      <button id="exportExcel">å¯¼å‡ºExcel</button>
      <button id="exportPdf">å¯¼å‡ºPDF</button>
      <button id="print">æ‰“å°</button>
    </div>

    <div class="report-container">
      <div class="info">
        <h3>ğŸ“Š DDRæŠ¥è¡¨å°è®¡åˆè®¡åŠŸèƒ½æ¼”ç¤º</h3>
        <p>æœ¬ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨æ•°æ®é¢„å¤„ç†å·¥å…·å®ç°æŠ¥è¡¨çš„å°è®¡å’Œåˆè®¡åŠŸèƒ½ï¼š</p>
        <ul>
          <li><strong>ç¤ºä¾‹1</strong>ï¼šæŒ‰åœ°åŒºåˆ†ç»„ï¼Œæ˜¾ç¤ºæ¯ä¸ªåœ°åŒºçš„é”€å”®é¢å’Œæ•°é‡å°è®¡</li>
          <li><strong>ç¤ºä¾‹2</strong>ï¼šå¤šçº§åˆ†ç»„ï¼ˆåœ°åŒº > äº§å“ç±»åˆ«ï¼‰ï¼Œæ˜¾ç¤ºå¤šå±‚çº§å°è®¡</li>
          <li><strong>ç¤ºä¾‹3</strong>ï¼šå¤æ‚æ±‡æ€»ï¼ŒåŒ…å«å¤šç§ç»Ÿè®¡ç±»å‹ï¼ˆæ±‚å’Œã€å¹³å‡å€¼ã€è®¡æ•°ç­‰ï¼‰</li>
        </ul>
        <p><strong>ç‰¹è‰²åŠŸèƒ½</strong>ï¼šå°è®¡è¡Œå’Œæ€»è®¡è¡Œå…·æœ‰ä¸åŒçš„æ ·å¼ï¼Œæ”¯æŒPDF/Excelå¯¼å‡ºæ—¶ä¿æŒæ ¼å¼</p>
      </div>
      <div id="report" class="report"></div>
    </div>
  </div>

  <script src="../../dist/ddr-core.browser.js"></script>
  <script type="module">
    // å¯¼å…¥å°è®¡å¤„ç†å·¥å…·ï¼ˆåœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨importï¼‰
    // import { processSubtotals, getSubtotalStyles } from '../../src/utils/subtotal-processor.js';

    // ç”±äºæµè§ˆå™¨ç¯å¢ƒé™åˆ¶ï¼Œè¿™é‡Œç›´æ¥åµŒå…¥å·¥å…·å‡½æ•°
    function calculateSummary(data, field, type = 'sum') {
      if (!data.length) return 0;
      const values = data.map(item => {
        const value = item[field];
        return typeof value === 'number' ? value : parseFloat(value) || 0;
      }).filter(val => !isNaN(val));
      if (!values.length) return 0;
      switch (type.toLowerCase()) {
        case 'sum': return values.reduce((sum, val) => sum + val, 0);
        case 'avg': return values.reduce((sum, val) => sum + val, 0) / values.length;
        case 'count': return values.length;
        case 'max': return Math.max(...values);
        case 'min': return Math.min(...values);
        default: return 0;
      }
    }

    function processSingleGroupSubtotals(data, options) {
      const {
        groupBy,
        subtotals = [],
        subtotalLabel = 'å°è®¡',
        showGrandTotal = true,
        grandTotalLabel = 'æ€»è®¡'
      } = options;

      if (!data.length || !groupBy) return data;

      const grouped = {};
      data.forEach(item => {
        const groupKey = item[groupBy];
        if (!grouped[groupKey]) grouped[groupKey] = [];
        grouped[groupKey].push({
          ...item,
          _rowType: 'data',
          _level: 0,
          _groupKey: groupKey
        });
      });

      const result = [];
      const grandTotals = {};

      Object.keys(grouped).forEach(groupKey => {
        const groupData = grouped[groupKey];
        result.push(...groupData);

        const subtotalRow = {
          [groupBy]: `${groupKey} ${subtotalLabel}`,
          _rowType: 'subtotal',
          _level: 1,
          _groupKey: groupKey,
          _isSubtotal: true
        };

        subtotals.forEach(subtotalConfig => {
          const { field, type = 'sum' } = subtotalConfig;
          const subtotalValue = calculateSummary(groupData, field, type);
          subtotalRow[field] = subtotalValue;
          if (showGrandTotal) {
            if (!grandTotals[field]) grandTotals[field] = { type, values: [] };
            grandTotals[field].values.push(subtotalValue);
          }
        });

        result.push(subtotalRow);
      });

      if (showGrandTotal && subtotals.length > 0) {
        const grandTotalRow = {
          [groupBy]: grandTotalLabel,
          _rowType: 'total',
          _level: 0,
          _isGrandTotal: true
        };

        subtotals.forEach(subtotalConfig => {
          const { field, type = 'sum' } = subtotalConfig;
          if (grandTotals[field]) {
            const { values } = grandTotals[field];
            grandTotalRow[field] = type === 'sum'
              ? values.reduce((sum, val) => sum + val, 0)
              : calculateSummary(data, field, type);
          }
        });

        result.push(grandTotalRow);
      }

      return result;
    }

    function processSubtotals(data, options = {}) {
      if (!Array.isArray(data) || data.length === 0) return data;
      const { groupBy, subtotals = [], ...otherOptions } = options;
      const groupField = Array.isArray(groupBy) ? groupBy[0] : groupBy;
      return processSingleGroupSubtotals(data, { groupBy: groupField, subtotals, ...otherOptions });
    }

    function getSubtotalStyles() {
      return [
        {
          when: 'row._rowType === "subtotal"',
          style: {
            fontWeight: 'bold',
            backgroundColor: '#f5f5f5',
            borderTop: '1px solid #d9d9d9'
          }
        },
        {
          when: 'row._rowType === "total"',
          style: {
            fontWeight: 'bold',
            backgroundColor: '#e6f7ff',
            color: '#1890ff',
            borderTop: '2px solid #1890ff'
          }
        }
      ];
    }

    // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
    function generateMockData(count = 50) {
      const regions = ['åä¸œ', 'åå—', 'ååŒ—', 'è¥¿å—'];
      const categories = ['ç”µå­äº§å“', 'å®¶å±…ç”¨å“', 'é£Ÿå“é¥®æ–™', 'æœè£…é‹å¸½'];
      const products = ['äº§å“A', 'äº§å“B', 'äº§å“C', 'äº§å“D', 'äº§å“E'];

      return Array.from({ length: count }, (_, index) => ({
        id: index + 1,
        date: new Date(2025, 4, (index % 30) + 1).toISOString().split('T')[0],
        region: regions[index % regions.length],
        category: categories[index % categories.length],
        product: products[index % products.length],
        quantity: Math.floor(Math.random() * 100) + 1,
        price: parseFloat((Math.random() * 1000 + 100).toFixed(2)),
        amount: parseFloat((Math.random() * 50000 + 1000).toFixed(2))
      }));
    }

    let currentReport = null;

    // ç¤ºä¾‹1ï¼šæŒ‰åœ°åŒºåˆ†ç»„å°è®¡
    function createDemo1() {
      const rawData = generateMockData(30);

      // å¤„ç†æ•°æ®ï¼ŒæŒ‰åœ°åŒºåˆ†ç»„å¹¶æ·»åŠ å°è®¡
      const processedData = processSubtotals(rawData, {
        groupBy: 'region',
        subtotals: [
          { field: 'amount', type: 'sum' },
          { field: 'quantity', type: 'sum' }
        ],
        subtotalLabel: 'å°è®¡',
        showGrandTotal: true,
        grandTotalLabel: 'æ€»è®¡'
      });

      return createReport(processedData, {
        title: 'é”€å”®æŠ¥è¡¨ - æŒ‰åœ°åŒºåˆ†ç»„å°è®¡',
        subtitle: 'å±•ç¤ºå„åœ°åŒºé”€å”®é¢å’Œæ•°é‡çš„å°è®¡æ±‡æ€»'
      });
    }

    // ç¤ºä¾‹2ï¼šå¤šçº§åˆ†ç»„å°è®¡ï¼ˆåœ°åŒº > äº§å“ç±»åˆ«ï¼‰
    function createDemo2() {
      const rawData = generateMockData(40);

      // å…ˆæŒ‰åœ°åŒºåˆ†ç»„
      const regionGrouped = processSubtotals(rawData, {
        groupBy: 'region',
        subtotals: [
          { field: 'amount', type: 'sum' },
          { field: 'quantity', type: 'sum' }
        ],
        subtotalLabel: 'åœ°åŒºå°è®¡',
        showGrandTotal: false
      });

      // å†æŒ‰äº§å“ç±»åˆ«åœ¨æ¯ä¸ªåœ°åŒºå†…åˆ†ç»„
      const result = [];
      let currentRegion = null;
      let regionData = [];

      regionGrouped.forEach(row => {
        if (row._rowType === 'subtotal') {
          // å¤„ç†å½“å‰åœ°åŒºçš„æ•°æ®
          if (regionData.length > 0) {
            const categoryGrouped = processSubtotals(regionData, {
              groupBy: 'category',
              subtotals: [
                { field: 'amount', type: 'sum' },
                { field: 'quantity', type: 'sum' }
              ],
              subtotalLabel: 'ç±»åˆ«å°è®¡',
              showGrandTotal: false
            });
            result.push(...categoryGrouped);
          }
          result.push(row); // æ·»åŠ åœ°åŒºå°è®¡è¡Œ
          regionData = [];
        } else if (row._rowType === 'data') {
          if (currentRegion !== row.region) {
            currentRegion = row.region;
          }
          regionData.push(row);
        }
      });

      // å¤„ç†æœ€åä¸€ä¸ªåœ°åŒºçš„æ•°æ®
      if (regionData.length > 0) {
        const categoryGrouped = processSubtotals(regionData, {
          groupBy: 'category',
          subtotals: [
            { field: 'amount', type: 'sum' },
            { field: 'quantity', type: 'sum' }
          ],
          subtotalLabel: 'ç±»åˆ«å°è®¡',
          showGrandTotal: false
        });
        result.push(...categoryGrouped);
      }

      // æ·»åŠ æ€»è®¡è¡Œ
      const grandTotalRow = {
        region: 'æ€»è®¡',
        _rowType: 'total',
        _level: 0,
        _isGrandTotal: true,
        amount: calculateSummary(rawData, 'amount', 'sum'),
        quantity: calculateSummary(rawData, 'quantity', 'sum')
      };
      result.push(grandTotalRow);

      return createReport(result, {
        title: 'é”€å”®æŠ¥è¡¨ - å¤šçº§åˆ†ç»„å°è®¡',
        subtitle: 'æŒ‰åœ°åŒºå’Œäº§å“ç±»åˆ«è¿›è¡Œå¤šå±‚çº§æ±‡æ€»'
      });
    }

    // ç¤ºä¾‹3ï¼šå¤æ‚æ±‡æ€»æŠ¥è¡¨ï¼ˆåŒ…å«å¤šç§ç»Ÿè®¡ç±»å‹ï¼‰
    function createDemo3() {
      const rawData = generateMockData(35);

      // å¤„ç†æ•°æ®ï¼ŒæŒ‰åœ°åŒºåˆ†ç»„å¹¶æ·»åŠ å¤šç§ç»Ÿè®¡ç±»å‹çš„å°è®¡
      const processedData = processSubtotals(rawData, {
        groupBy: 'region',
        subtotals: [
          { field: 'amount', type: 'sum' },
          { field: 'quantity', type: 'sum' },
          { field: 'price', type: 'avg' }
        ],
        subtotalLabel: 'å°è®¡',
        showGrandTotal: true,
        grandTotalLabel: 'æ€»è®¡'
      });

      // ä¸ºå¤æ‚æ±‡æ€»æŠ¥è¡¨æ·»åŠ é¢å¤–çš„ç»Ÿè®¡åˆ—
      const enhancedData = processedData.map(row => {
        if (row._rowType === 'subtotal' || row._rowType === 'total') {
          return {
            ...row,
            avgAmount: row.quantity > 0 ? (row.amount / row.quantity).toFixed(2) : 0,
            maxAmount: row._rowType === 'total' ? Math.max(...rawData.map(r => r.amount)).toFixed(2) : '',
            minAmount: row._rowType === 'total' ? Math.min(...rawData.map(r => r.amount)).toFixed(2) : ''
          };
        }
        return {
          ...row,
          avgAmount: row.quantity > 0 ? (row.amount / row.quantity).toFixed(2) : 0,
          maxAmount: '',
          minAmount: ''
        };
      });

      return createComplexReport(enhancedData, {
        title: 'é”€å”®æŠ¥è¡¨ - å¤æ‚æ±‡æ€»ç»Ÿè®¡',
        subtitle: 'åŒ…å«æ±‚å’Œã€å¹³å‡å€¼ã€æœ€å¤§å€¼ã€æœ€å°å€¼ç­‰å¤šç§ç»Ÿè®¡ç±»å‹'
      });
    }

    // å¤æ‚æŠ¥è¡¨é…ç½®ï¼ˆåŒ…å«æ›´å¤šç»Ÿè®¡åˆ—ï¼‰
    function createComplexReport(data, options = {}) {
      const { title = 'é”€å”®æŠ¥è¡¨', subtitle = '' } = options;

      const config = {
        dataSource: { data },
        header: {
          title: { text: title },
          subtitle: { text: subtitle },
          fields: [
            { key: 'reportDate', label: 'æŠ¥è¡¨æ—¥æœŸ:', value: new Date().toLocaleDateString() },
            { key: 'dataCount', label: 'æ•°æ®æ¡æ•°:', value: data.length.toString(), position: 'right' }
          ]
        },
        columns: [
          {
            key: 'id',
            title: 'åºå·',
            width: 60,
            align: 'center'
          },
          {
            key: 'region',
            title: 'åœ°åŒº',
            width: 100,
            merge: 'vertical',
            style: {
              conditional: getSubtotalStyles()
            }
          },
          {
            key: 'category',
            title: 'ç±»åˆ«',
            width: 100,
            style: {
              conditional: getSubtotalStyles()
            }
          },
          {
            key: 'quantity',
            title: 'æ•°é‡',
            width: 80,
            align: 'right',
            formatter: 'number',
            style: {
              conditional: getSubtotalStyles()
            }
          },
          {
            key: 'amount',
            title: 'é”€å”®é¢',
            width: 120,
            align: 'right',
            formatter: 'currency',
            style: {
              conditional: getSubtotalStyles()
            }
          },
          {
            key: 'price',
            title: 'å¹³å‡å•ä»·',
            width: 100,
            align: 'right',
            formatter: 'currency',
            style: {
              conditional: getSubtotalStyles()
            }
          },
          {
            key: 'avgAmount',
            title: 'å•ä»¶å‡é¢',
            width: 100,
            align: 'right',
            formatter: 'currency',
            style: {
              conditional: getSubtotalStyles()
            }
          },
          {
            key: 'maxAmount',
            title: 'æœ€å¤§é‡‘é¢',
            width: 100,
            align: 'right',
            formatter: 'currency',
            style: {
              conditional: [
                ...getSubtotalStyles(),
                {
                  when: 'row._rowType === "total" && row.maxAmount',
                  style: {
                    color: '#f5222d',
                    fontWeight: 'bold'
                  }
                }
              ]
            }
          },
          {
            key: 'minAmount',
            title: 'æœ€å°é‡‘é¢',
            width: 100,
            align: 'right',
            formatter: 'currency',
            style: {
              conditional: [
                ...getSubtotalStyles(),
                {
                  when: 'row._rowType === "total" && row.minAmount',
                  style: {
                    color: '#52c41a',
                    fontWeight: 'bold'
                  }
                }
              ]
            }
          }
        ],
        layout: {
          rowHeight: 40,
          stripe: true,
          bordered: true,
          hover: true
        },
        features: {
          exportExcel: true,
          exportPdf: true,
          watermark: 'æ·±åœ³å¸‚ä¸‰è”ä¼—ç‘ç§‘æŠ€æœ‰é™å…¬å¸'
        }
      };

      if (currentReport) {
        currentReport.destroy();
      }

      currentReport = DDR.create({
        container: document.getElementById('report'),
        config: config,
        onLoad: () => console.log('å¤æ‚æŠ¥è¡¨åŠ è½½å®Œæˆ'),
        onError: (error) => console.error('å¤æ‚æŠ¥è¡¨åŠ è½½å‡ºé”™:', error)
      });

      return currentReport;
    }

    // åŸºç¡€æŠ¥è¡¨é…ç½®
    function createReport(data, options = {}) {
      const { title = 'é”€å”®æŠ¥è¡¨', subtitle = '' } = options;

      const config = {
        dataSource: { data },
        header: {
          title: { text: title },
          subtitle: { text: subtitle },
          fields: [
            { key: 'reportDate', label: 'æŠ¥è¡¨æ—¥æœŸ:', value: new Date().toLocaleDateString() },
            { key: 'dataCount', label: 'æ•°æ®æ¡æ•°:', value: data.length.toString(), position: 'right' }
          ]
        },
        columns: [
          {
            key: 'id',
            title: 'åºå·',
            width: 80,
            align: 'center'
          },
          {
            key: 'region',
            title: 'åœ°åŒº',
            width: 100,
            merge: 'vertical',
            style: {
              conditional: getSubtotalStyles()
            }
          },
          {
            key: 'category',
            title: 'äº§å“ç±»åˆ«',
            width: 120,
            style: {
              conditional: getSubtotalStyles()
            }
          },
          {
            key: 'product',
            title: 'äº§å“åç§°',
            width: 120,
            style: {
              conditional: getSubtotalStyles()
            }
          },
          {
            key: 'quantity',
            title: 'é”€å”®æ•°é‡',
            width: 100,
            align: 'right',
            formatter: 'number',
            style: {
              conditional: getSubtotalStyles()
            }
          },
          {
            key: 'amount',
            title: 'é”€å”®é¢',
            width: 150,
            align: 'right',
            formatter: 'currency',
            style: {
              conditional: getSubtotalStyles()
            }
          }
        ],
        layout: {
          rowHeight: 40,
          stripe: true,
          bordered: true,
          hover: true
        },
        features: {
          exportExcel: true,
          exportPdf: true,
          watermark: 'æ·±åœ³å¸‚ä¸‰è”ä¼—ç‘ç§‘æŠ€æœ‰é™å…¬å¸'
        }
      };

      if (currentReport) {
        currentReport.destroy();
      }

      currentReport = DDR.create({
        container: document.getElementById('report'),
        config: config,
        onLoad: () => console.log('æŠ¥è¡¨åŠ è½½å®Œæˆ'),
        onError: (error) => console.error('æŠ¥è¡¨åŠ è½½å‡ºé”™:', error)
      });

      return currentReport;
    }

    // ç»‘å®šäº‹ä»¶
    document.getElementById('demo1').addEventListener('click', createDemo1);
    document.getElementById('demo2').addEventListener('click', createDemo2);
    document.getElementById('demo3').addEventListener('click', createDemo3);

    document.getElementById('exportExcel').addEventListener('click', () => {
      if (currentReport) {
        currentReport.exportTo('excel', {
          fileName: 'é”€å”®æŠ¥è¡¨_å°è®¡åˆè®¡_' + new Date().toISOString().split('T')[0]
        });
      }
    });

    document.getElementById('exportPdf').addEventListener('click', () => {
      if (currentReport) {
        currentReport.exportTo('pdf', {
          fileName: 'é”€å”®æŠ¥è¡¨_å°è®¡åˆè®¡_' + new Date().toISOString().split('T')[0]
        });
      }
    });

    document.getElementById('print').addEventListener('click', () => {
      if (currentReport) {
        currentReport.print();
      }
    });

    // é»˜è®¤åŠ è½½ç¤ºä¾‹1
    document.addEventListener('DOMContentLoaded', () => {
      createDemo1();
    });
  </script>
</body>
</html>
