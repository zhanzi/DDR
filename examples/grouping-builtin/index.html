<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DDRæŠ¥è¡¨å†…ç½®åˆ†ç»„å°è®¡åŠŸèƒ½æ¼”ç¤º</title>
  <link rel="stylesheet" href="../../dist/ddr-core.css">
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB',
        'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    .container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .toolbar {
      padding: 16px;
      background-color: #f5f5f5;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .report-container {
      flex: 1;
      padding: 16px;
      overflow: auto;
    }

    .report {
      height: 100%;
      border: 1px solid #e0e0e0;
      overflow: auto;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    button {
      padding: 8px 16px;
      border: none;
      background-color: #1890ff;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
      font-size: 14px;
    }

    button:hover {
      background-color: #40a9ff;
    }

    button:disabled {
      background-color: #d9d9d9;
      color: #999;
      cursor: not-allowed;
    }

    button:disabled:hover {
      background-color: #d9d9d9;
    }

    .demo-button {
      background-color: #52c41a;
    }

    .demo-button:hover {
      background-color: #73d13d;
    }

    .config-button {
      background-color: #722ed1;
    }

    .config-button:hover {
      background-color: #9254de;
    }

    .info {
      background-color: #e6f7ff;
      border: 1px solid #91d5ff;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .info h3 {
      margin: 0 0 8px 0;
      color: #1890ff;
    }

    .info ul {
      margin: 8px 0 0 0;
      padding-left: 20px;
    }

    .info li {
      margin: 4px 0;
    }

    .config-panel {
      background-color: #f9f9f9;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .config-panel h4 {
      margin: 0 0 8px 0;
      color: #722ed1;
    }

    .config-code {
      background-color: #f6f8fa;
      border: 1px solid #e1e4e8;
      border-radius: 3px;
      padding: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      overflow-x: auto;
      white-space: pre;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="toolbar">
      <button id="demo1" class="demo-button">åŸºç¡€åˆ†ç»„å°è®¡</button>
      <button id="demo2" class="demo-button">å¤šå­—æ®µæ±‡æ€»</button>
      <button id="demo3" class="demo-button">è‡ªå®šä¹‰æ ·å¼</button>
      <button id="showConfig" class="config-button">æ˜¾ç¤ºé…ç½®</button>
      <button id="exportExcel">å¯¼å‡ºExcel</button>
      <button id="exportPdf">å¯¼å‡ºPDF</button>
      <button id="print">æ‰“å°</button>
    </div>

    <div class="report-container">
      <div class="info">
        <h3>ğŸš€ DDRæŠ¥è¡¨å†…ç½®åˆ†ç»„å°è®¡åŠŸèƒ½æ¼”ç¤º</h3>
        <p>æœ¬ç¤ºä¾‹å±•ç¤ºäº†DDRç»„ä»¶å†…ç½®çš„åˆ†ç»„å°è®¡åŠŸèƒ½ï¼Œæ— éœ€æ‰‹åŠ¨é¢„å¤„ç†æ•°æ®ï¼š</p>
        <ul>
          <li><strong>åŸºç¡€åˆ†ç»„å°è®¡</strong>ï¼šé€šè¿‡é…ç½®groupingé€‰é¡¹å®ç°æŒ‰åœ°åŒºåˆ†ç»„çš„é”€å”®é¢å°è®¡</li>
          <li><strong>å¤šå­—æ®µæ±‡æ€»</strong>ï¼šåŒæ—¶å¯¹å¤šä¸ªå­—æ®µè¿›è¡Œä¸åŒç±»å‹çš„æ±‡æ€»ç»Ÿè®¡</li>
          <li><strong>è‡ªå®šä¹‰æ ·å¼</strong>ï¼šè‡ªå®šä¹‰å°è®¡è¡Œå’Œæ€»è®¡è¡Œçš„æ˜¾ç¤ºæ ·å¼</li>
          <li><strong>è‡ªåŠ¨å¤„ç†</strong>ï¼šç»„ä»¶è‡ªåŠ¨å¤„ç†æ•°æ®åˆ†ç»„ã€å°è®¡è®¡ç®—å’Œæ ·å¼åº”ç”¨</li>
        </ul>
        <p><strong>ä¼˜åŠ¿</strong>ï¼šé…ç½®ç®€å•ã€æ ·å¼ç»Ÿä¸€ã€å¯¼å‡ºå…¼å®¹ã€æ€§èƒ½ä¼˜åŒ–</p>
      </div>

      <div id="configPanel" class="config-panel" style="display: none;">
        <h4>ğŸ“‹ å½“å‰é…ç½®</h4>
        <div id="configCode" class="config-code"></div>
      </div>

      <div id="report" class="report"></div>
    </div>
  </div>

  <script src="../../dist/ddr-core.browser.js"></script>
  <script>
    // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
    function generateMockData(count = 40) {
      const regions = ['åä¸œ', 'åå—', 'ååŒ—', 'è¥¿å—', 'åä¸­'];
      const categories = ['ç”µå­äº§å“', 'å®¶å±…ç”¨å“', 'é£Ÿå“é¥®æ–™', 'æœè£…é‹å¸½'];
      const products = ['äº§å“A', 'äº§å“B', 'äº§å“C', 'äº§å“D', 'äº§å“E', 'äº§å“F'];
      const salespeople = ['å¼ ä¸‰', 'æå››', 'ç‹äº”', 'èµµå…­', 'é’±ä¸ƒ'];

      return Array.from({ length: count }, (_, index) => ({
        id: index + 1,
        date: new Date(2025, 4, (index % 30) + 1).toISOString().split('T')[0],
        region: regions[index % regions.length],
        category: categories[index % categories.length],
        product: products[index % products.length],
        salesperson: salespeople[index % salespeople.length],
        quantity: Math.floor(Math.random() * 100) + 1,
        price: parseFloat((Math.random() * 1000 + 100).toFixed(2)),
        amount: parseFloat((Math.random() * 50000 + 1000).toFixed(2)),
        cost: parseFloat((Math.random() * 30000 + 500).toFixed(2))
      }));
    }

    let currentReport = null;
    let currentConfig = null;

    // åŸºç¡€åˆ—é…ç½®
    function getBaseColumns() {
      return [
        {
          key: 'id',
          title: 'åºå·',
          width: 80,
          align: 'center'
        },
        {
          key: 'region',
          title: 'åœ°åŒº',
          width: 100,
          merge: 'vertical'
        },
        {
          key: 'category',
          title: 'äº§å“ç±»åˆ«',
          width: 120
        },
        {
          key: 'product',
          title: 'äº§å“åç§°',
          width: 120
        },
        {
          key: 'salesperson',
          title: 'é”€å”®å‘˜',
          width: 100
        },
        {
          key: 'quantity',
          title: 'é”€å”®æ•°é‡',
          width: 100,
          align: 'right',
          formatter: 'number'
        },
        {
          key: 'price',
          title: 'å•ä»·',
          width: 120,
          align: 'right',
          formatter: 'currency'
        },
        {
          key: 'amount',
          title: 'é”€å”®é¢',
          width: 150,
          align: 'right',
          formatter: 'currency'
        },
        {
          key: 'cost',
          title: 'æˆæœ¬',
          width: 120,
          align: 'right',
          formatter: 'currency'
        }
      ];
    }

    // ç¤ºä¾‹1ï¼šåŸºç¡€åˆ†ç»„å°è®¡
    function createDemo1() {
      const rawData = generateMockData(120);

      const config = {
        dataSource: { data: rawData },
        header: {
          title: { text: 'é”€å”®æŠ¥è¡¨ - åŸºç¡€åˆ†ç»„å°è®¡' },
          subtitle: { text: 'ä½¿ç”¨å†…ç½®åˆ†ç»„åŠŸèƒ½æŒ‰åœ°åŒºç»Ÿè®¡é”€å”®é¢å’Œæ•°é‡' },
          fields: [
            { key: 'reportDate', label: 'æŠ¥è¡¨æ—¥æœŸ:', value: new Date().toLocaleDateString() },
            { key: 'dataCount', label: 'æ•°æ®æ¡æ•°:', value: rawData.length.toString(), position: 'right' }
          ]
        },
        // å†…ç½®åˆ†ç»„é…ç½®
        grouping: {
          enabled: true,
          groupBy: 'region',
          subtotals: [
            { field: 'amount', type: 'sum' },
            { field: 'quantity', type: 'sum' }
          ],
          subtotalLabel: 'å°è®¡',
          showGrandTotal: true,
          grandTotalLabel: 'æ€»è®¡'
        },
        columns: getBaseColumns(),
        layout: {
          rowHeight: 40,
          stripe: true,
          bordered: true,
          hover: true
        },
        features: {
          exportExcel: true,
          exportPdf: true,
          watermark: 'æ·±åœ³å¸‚ä¸‰è”ä¼—ç‘ç§‘æŠ€æœ‰é™å…¬å¸'
        }
      };

      currentConfig = config;
      return createReport(config, 'åŸºç¡€åˆ†ç»„å°è®¡æ¼”ç¤º');
    }

    // ç¤ºä¾‹2ï¼šå¤šå­—æ®µæ±‡æ€»
    function createDemo2() {
      // ç”Ÿæˆæ›´å¤šæ ·åŒ–çš„æ•°æ®ï¼Œç¡®ä¿æ¯ä¸ªåœ°åŒºæœ‰è¶³å¤Ÿçš„æ•°æ®
      const regions = ['åä¸œ', 'åå—', 'ååŒ—'];
      const categories = ['ç”µå­äº§å“', 'å®¶å±…ç”¨å“', 'é£Ÿå“é¥®æ–™'];
      const products = ['äº§å“A', 'äº§å“B', 'äº§å“C'];
      const salespeople = ['å¼ ä¸‰', 'æå››', 'ç‹äº”'];

      const rawData = [];
      let id = 1;

      // ä¸ºæ¯ä¸ªåœ°åŒºç”Ÿæˆæ•°æ®
      regions.forEach((region, regionIndex) => {
        // æ¯ä¸ªåœ°åŒºç”Ÿæˆ8-12æ¡æ•°æ®
        const count = 8 + Math.floor(Math.random() * 5);
        for (let i = 0; i < count; i++) {
          rawData.push({
            id: id++,
            date: new Date(2025, 4, (id % 30) + 1).toISOString().split('T')[0],
            region: region,
            category: categories[i % categories.length],
            product: products[i % products.length],
            salesperson: salespeople[i % salespeople.length],
            quantity: Math.floor(Math.random() * 100) + 10,
            price: parseFloat((Math.random() * 800 + 200).toFixed(2)),
            amount: parseFloat((Math.random() * 40000 + 5000).toFixed(2)),
            cost: parseFloat((Math.random() * 25000 + 2000).toFixed(2))
          });
        }
      });

      const config = {
        dataSource: { data: rawData },
        header: {
          title: { text: 'é”€å”®æŠ¥è¡¨ - å¤šå­—æ®µæ±‡æ€»ç»Ÿè®¡' },
          subtitle: { text: 'æŒ‰åœ°åŒºåˆ†ç»„ï¼Œå¯¹å¤šä¸ªå­—æ®µè¿›è¡Œä¸åŒç±»å‹çš„æ±‡æ€»è®¡ç®—' },
          fields: [
            { key: 'reportDate', label: 'æŠ¥è¡¨æ—¥æœŸ:', value: new Date().toLocaleDateString() },
            { key: 'dataCount', label: 'æ•°æ®æ¡æ•°:', value: rawData.length.toString(), position: 'right' }
          ]
        },
        // å¤šå­—æ®µæ±‡æ€»é…ç½®
        grouping: {
          enabled: true,
          groupBy: 'region',
          subtotals: [
            { field: 'amount', type: 'sum' },      // é”€å”®é¢æ±‚å’Œ
            { field: 'cost', type: 'sum' },        // æˆæœ¬æ±‚å’Œ
            { field: 'quantity', type: 'sum' },    // æ•°é‡æ±‚å’Œ
            { field: 'price', type: 'avg' }        // å•ä»·å¹³å‡å€¼
          ],
          subtotalLabel: 'åœ°åŒºå°è®¡',
          showGrandTotal: true,
          grandTotalLabel: 'æ€»è®¡'
        },
        columns: getBaseColumns(),
        layout: {
          rowHeight: 40,
          stripe: true,
          bordered: true,
          hover: true
        },
        features: {
          exportExcel: true,
          exportPdf: true,
          watermark: 'æ·±åœ³å¸‚ä¸‰è”ä¼—ç‘ç§‘æŠ€æœ‰é™å…¬å¸'
        }
      };

      currentConfig = config;
      return createReport(config, 'å¤šå­—æ®µæ±‡æ€»æ¼”ç¤º');
    }

    // ç¤ºä¾‹3ï¼šè‡ªå®šä¹‰æ ·å¼
    function createDemo3() {
      const rawData = generateMockData(120);

      const config = {
        dataSource: { data: rawData },
        header: {
          title: { text: 'é”€å”®æŠ¥è¡¨ - è‡ªå®šä¹‰åˆ†ç»„æ ·å¼' },
          subtitle: { text: 'è‡ªå®šä¹‰å°è®¡è¡Œå’Œæ€»è®¡è¡Œçš„æ˜¾ç¤ºæ ·å¼' },
          fields: [
            { key: 'reportDate', label: 'æŠ¥è¡¨æ—¥æœŸ:', value: new Date().toLocaleDateString() },
            { key: 'dataCount', label: 'æ•°æ®æ¡æ•°:', value: rawData.length.toString(), position: 'right' }
          ]
        },
        // è‡ªå®šä¹‰æ ·å¼çš„åˆ†ç»„é…ç½®
        grouping: {
          enabled: true,
          groupBy: 'category',
          subtotals: [
            { field: 'amount', type: 'sum' },
            { field: 'quantity', type: 'sum' },
            { field: 'cost', type: 'sum' }
          ],
          subtotalLabel: 'ç±»åˆ«å°è®¡',
          showGrandTotal: true,
          grandTotalLabel: 'æ€»è®¡',
          // è‡ªå®šä¹‰æ ·å¼
          styles: {
            subtotalRow: {
              fontWeight: 'bold',
              backgroundColor: '#fff7e6',
              borderTop: '2px solid #ffa940',
              color: '#d46b08'
            },
            totalRow: {
              fontWeight: 'bold',
              backgroundColor: '#f6ffed',
              borderTop: '2px solid #52c41a',
              color: '#389e0d'
            },
            groupColumn: {
              fontWeight: '600',
              color: '#722ed1'
            }
          }
        },
        columns: getBaseColumns(),
        layout: {
          rowHeight: 40,
          stripe: true,
          bordered: true,
          hover: true
        },
        features: {
          exportExcel: true,
          exportPdf: true,
          watermark: 'æ·±åœ³å¸‚ä¸‰è”ä¼—ç‘ç§‘æŠ€æœ‰é™å…¬å¸'
        }
      };

      currentConfig = config;
      return createReport(config, 'è‡ªå®šä¹‰æ ·å¼æ¼”ç¤º');
    }

    // åˆ›å»ºæŠ¥è¡¨
    function createReport(config, description) {
      if (currentReport) {
        currentReport.destroy();
      }

      currentReport = DDR.create({
        container: document.getElementById('report'),
        config: config,
        onLoad: () => {
          console.log(`${description}åŠ è½½å®Œæˆ`);
          // æŠ¥è¡¨åŠ è½½å®Œæˆåï¼Œå¯ç”¨å¯¼å‡ºæŒ‰é’®
          enableExportButtons();
        },
        onError: (error) => console.error(`${description}åŠ è½½å‡ºé”™:`, error)
      });

      // æŠ¥è¡¨åˆ›å»ºæ—¶ï¼Œæš‚æ—¶ç¦ç”¨å¯¼å‡ºæŒ‰é’®
      disableExportButtons();

      return currentReport;
    }

    // ç¦ç”¨å¯¼å‡ºæŒ‰é’®
    function disableExportButtons() {
      document.getElementById('exportExcel').disabled = true;
      document.getElementById('exportPdf').disabled = true;
      document.getElementById('print').disabled = true;
    }

    // å¯ç”¨å¯¼å‡ºæŒ‰é’®
    function enableExportButtons() {
      document.getElementById('exportExcel').disabled = false;
      document.getElementById('exportPdf').disabled = false;
      document.getElementById('print').disabled = false;
    }

    // æ˜¾ç¤ºé…ç½®
    function showConfig() {
      const configPanel = document.getElementById('configPanel');
      const configCode = document.getElementById('configCode');

      if (configPanel.style.display === 'none') {
        configPanel.style.display = 'block';
        if (currentConfig) {
          configCode.textContent = JSON.stringify(currentConfig.grouping, null, 2);
        }
        document.getElementById('showConfig').textContent = 'éšè—é…ç½®';
      } else {
        configPanel.style.display = 'none';
        document.getElementById('showConfig').textContent = 'æ˜¾ç¤ºé…ç½®';
      }
    }

    // ç»‘å®šäº‹ä»¶
    document.getElementById('demo1').addEventListener('click', createDemo1);
    document.getElementById('demo2').addEventListener('click', createDemo2);
    document.getElementById('demo3').addEventListener('click', createDemo3);
    document.getElementById('showConfig').addEventListener('click', showConfig);

    document.getElementById('exportExcel').addEventListener('click', async () => {
      if (currentReport) {
        // æ·»åŠ çŸ­æš‚å»¶è¿Ÿç¡®ä¿DOMå®Œå…¨æ›´æ–°
        await new Promise(resolve => setTimeout(resolve, 100));

        console.log('å¼€å§‹Excelå¯¼å‡ºï¼Œå½“å‰æ•°æ®è¡Œæ•°:', currentReport.data?.length || 'æœªçŸ¥');

        currentReport.exportTo('excel', {
          fileName: 'é”€å”®æŠ¥è¡¨_å†…ç½®åˆ†ç»„_' + new Date().toISOString().split('T')[0]
        });
      }
    });

    document.getElementById('exportPdf').addEventListener('click', async () => {
      if (currentReport) {
        // æ·»åŠ çŸ­æš‚å»¶è¿Ÿç¡®ä¿DOMå®Œå…¨æ›´æ–°
        await new Promise(resolve => setTimeout(resolve, 100));

        console.log('å¼€å§‹PDFå¯¼å‡ºï¼Œå½“å‰æ•°æ®è¡Œæ•°:', currentReport.data?.length || 'æœªçŸ¥');

        currentReport.exportTo('pdf', {
          fileName: 'é”€å”®æŠ¥è¡¨_å†…ç½®åˆ†ç»„_' + new Date().toISOString().split('T')[0]
        });
      }
    });

    document.getElementById('print').addEventListener('click', () => {
      if (currentReport) {
        currentReport.print();
      }
    });

    // é»˜è®¤åŠ è½½ç¤ºä¾‹1
    document.addEventListener('DOMContentLoaded', () => {
      createDemo1();
    });
  </script>
</body>
</html>
